\documentclass[draft]{ametsoc}

\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{siunitx}
\usepackage[title]{appendix}

\bibpunct{(}{)}{;}{a}{}{,}
\newcommand{\TODO}[1]{\textcolor{purple}{TODO: \emph{#1}}}

\title{Comparison of Terrain Following and Cut Cell Grids using a Non-Hydrostatic Model}
\authors{James Shaw\correspondingauthor{Department of Meteorology, University of Reading, Earley Gate, PO Box 243, Reading, RG6 6BB, UK.} and Hilary Weller}
\affiliation{Department of Meteorology, University of Reading, Reading, United Kingdom}
\email{js102@zepler.net}

% Every term in the discretised equations of motion is a potential source of numerical error.
% Errors in calculating the horizontal pressure gradient generate spurious circulations and much effort has been put into improving this calculation.  This is often achieved by making the grid more orthogonal: flattening terrain following coordinate surfaces [citations] or using a cut cell approach [citations].
% TF citations: mahrer1984, schaer2002, klemp2011
% cut cell citations: good2014, yamazaki2015 puts this clearly but not yet published
% In a test of a stably stratified atmosphere initially at rest, we find that spurious velocities are no more than \SI{0.1}{\meter\per\second} on any grid. [TODO: and this is much better than klemp2011]
% Advection terms also contribute to numerical error.  We show that advection is most accurate when the flow is aligned with the grid layers.  Near the surface, flow tends to follow the terrain which results in larger errors when more orthogonal grids are used.
% In a test of orographically induced gravity waves, we find that the advection of potential temperature generates grid-scale errors on the cut cell grid.

\abstract{Terrain following coordinates are widely used in operational models but the cut cell method has been proposed as an alternative that can more accurately represent atmospheric dynamics over steep orography.  Because the type of grid is usually chosen during model implementation, it is typically necessary to use different models in order to compare the accuracy of different grids.  In contrast, here a single C-grid finite volume model is used to enable a like-for-like comparison of terrain following and cut cell grids.
A series of standard two-dimensional tests using idealised terrain are performed: tracer advection in a prescribed horizontal velocity field, a test starting from stably stratified initial conditions, and orographically induced gravity waves described by nonhydrostatic dynamics.  In addition, a new tracer advection test is formulated having a velocity field that is everywhere tangential to the terrain following coordinate surfaces.  This new test presents a challenge to cut cells in situations with a large Froude number and large Scorer parameter.  \TODO{discuss Froude number/Scorer parameter in body.}
The results of the advection tests demonstrate that tracer accuracy depends upon alignment of the flow with the grid.  As expected, the cut cell grid maintains greater accuracy in the test of stationary, stratified flow.  In the gravity waves test, results on all grids are in good agreement with existing results from the literature.}

\begin{document}

\maketitle

\section{Introduction}
Representing orography accurately in numerical weather prediction systems is necessary to model downslope winds and local precipitation.  Orography also exerts strong non-local influences: from the latent heat release due to convection, by directly forcing planetary waves, and by the atmospheric response to form drag and gravity wave drag.  There are two main approaches to representing orography on a grid: terrain following layers and cut cells.  Another way of treating orography is the immersed (or embedded) boundary method \citep{simon2012}.  All methods align cells in vertical columns.  Because most models are designed for a particular type of grid, existing studies of cut cell solutions have compared results with terrain following grid solutions implemented within different models, for example \citet{good2014}.  Instead, this study uses a single model to enable a like-for-like comparison between solutions using terrain following and cut cell grids.

With increasing horizontal model resolution, the discrete representation of terrain can become steeper, making accurate calculation of the horizontal pressure gradient more difficult when using terrain following layers \citep{gary1973,steppeler2002}.  Numerical errors in this calculation result in spurious winds and can cause numerical instability \citep{fast2003,webster2003}.  Cut cell methods seek to reduce the error that is associated with steep orography.

With terrain following (TF) layers the terrain's influence decays with height so that the bottommost layers follow the underlying surface closely while the uppermost layers are flat.  There are two main approaches to minimizing errors associated with TF layers.  First, by smoothing the effects of terrain with height, the influence of the terrain is reduced, hence errors in the calculated horizontal pressure gradient are also reduced aloft \citep{schaer2002,leuenberger2010,klemp2011}.  However, the error is not reduced at the ground where steep terrain remains unmodified.

Second, numerical errors can also be reduced by improving the accuracy in calculating the horizontal pressure gradient itself.  TF layers are usually implemented using a coordinate transformation onto a rectangular computational domain, which introduces metric terms into the equations of motion.  The techniques proposed by \citet{klemp2011} and \cite{zaengl2012} both involve interpolation onto $z$-levels in order to calculate the horizontal pressure gradient.  This gave them the flexibility to design more accurate horizontal pressure gradient discretizations using more appropriate stencils.

Despite their associated numerical errors, TF layers are in widespread operational use \citep{steppeler2003}.  They are attractive because their rectangular structure is simple to process by computer and link with parameterisations, and boundary layer resolution can be increased with variable spacing of vertical layers \citep{schaer2002}.

Cut cells is an alternative method in which the grid does not follow the terrain but, instead, cells that lie entirely below the terrain are removed, and those that intersect the surface are modified in shape so that they more closely fit the terrain.  The resulting grid is orthogonal everywhere except near cells that have been cut.  Hence, errors are still introduced when calculating the horizontal pressure gradient between cut and uncut cells.

The cut cell method can create some very small cells which reduce computational efficiency \citep{klein2009}, and several approaches have been tried to alleviate the problem.  \citet{yamazaki-satomura2010} combine small cells with horizontally or vertically adjacent cells.  \citet{steppeler2002} employ a thin-wall appoximation to increase the computational volume of small cells without altering the terrain.  \citet{jebens2011} avoid the timestep restriction associated with explicit schemes by using an implicit method for cut cells and a semi-explicit method elsewhere.

Several studies have shown examples where cut cells produce more accurate results when compared to TF coordinates.  Spurious winds seen in TF coordinates are not present with cut cells and errors do not increase with steeper terrain \citep{good2014}.  A comparison of TF and cut cells using real initial data by \citet{steppeler2013} found that five-day forecasts of precipitation and wind over Asia in January 1989 were more accurate in the cut cell model.

Another alternative method is the eta coordinate, described by \citet{mesinger1988}.  This transformation, expressed in pressure coordinates, quantises the surface pressure at each grid box using prescribed geometric heights.  This results in terrain profiles having a staircase pattern which is known as `step' orography.  The eta coordinate improves the accuracy of the horizontal pressure gradient calculation compared to the sigma coordinate \citep{mesinger1988}.

In an experiment of orographically induced gravity waves, \citet{gallus-klemp2000} found that horizontal flow along the lee slope was artificially weak in the Eta model.  \citet{mesinger2012} offer an explanation for this behaviour: air flowing along the lee slope cannot travel diagonally downwards but must first travel horizontally, then vertically downward.  However, lee slope winds are weakened because some of the air continues to be transported horizontally aloft.

\citet{mesinger2012} refined the formulation to allow diagonal transport of momentum and temperature immediately above sloping terrain.  This arrangement is similar to the finite volume cut cell method.  The new method improved test results, increasing lee slope winds by \SIrange{4}{5}{\meter\per\second} \citep{mesinger2012}.

This study uses a modification of the fully-compressible model from \citet{weller-shahrokhi2014} to enable a like-for-like comparison between terrain following and cut cell grids for idealised, two-dimensional test cases from the literature.  Section 2 presents the formulation of the terrain following and cut cell grids used in the experiments that follow.  In section 3 we give the governing equations, outline the model from \citet{weller-shahrokhi2014} and describe the modification which improves stability for long timesteps in the presence of steep orography.  Section 4 analyses the results from two tracer advection tests, a test of a stably stratified atmosphere initially at rest, and orographically induced gravity waves.  Concluding remarks are made in section 5.


\section{Grids}
\label{sec:grid}

Here we describe the formulation of the terrain following grids and the method of cut cell grid construction.  The techniques presented are used to define the grids for the experiments in the subsequent section.

\citet{galchen-somerville1975} proposed a basic terrain following (BTF) coordinate defined as 
\begin{equation}
	z = \left( H - h \right) \left( z^\star / H \right) + h \label{eqn:btf}
\end{equation}
where, in two dimensions, \(z(x, z^\star)\) is the physical height of the Cartesian coordinate surface at the model level with transformed height \(z^\star\), \(H\) is the height of the domain, and \(h(x)\) is the height of the terrain surface.  In this formulation $z$ varies between $h$ and $H$ and $z^\star$ ranges from 0 to $H$.  Using this coordinate, the terrain's influence decays linearly with height but disappears only at the top of the domain.  An example is shown in figure~\ref{fig:grid}a.

The smooth level vertical (SLEVE) coordinate proposed by \citet{schaer2002} achieves a more regular TF grid in the middle and top of the domain than the BTF coordinate.  The terrain height is split into large-scale and small-scale components, \(h_1\) and \(h_2\), such that \(h = h_1 + h_2\), with each component having a different exponential decay. The transformation is defined as 
\begin{align}
	z &= z^\star + h_1 b_1 + h_2 b_2
\intertext{where the vertical decay functions are given by}
	b_i &= \frac{\sinh \left( \left( H / s_i \right)^n - \left( z^\star / s_i \right)^n \right)}{\sinh \left( H / s_i \right)^n}
\end{align}
with \(s_1\) and \(s_2\) are the scale heights of large-scale and small-scale terrain respectively.  The exponent \(n\) was introduced by \citet{leuenberger2010} in order to increase cell thickness in the layers nearest the ground, allowing longer timesteps.  \citet{leuenberger2010} found the exponent has an optimal value of \(n = 1.35\).  Choosing \(n = 1\) gives the decay functions used by \citet{schaer2002}.  An example of the SLEVE grid can be seen in figure~\ref{fig:grid}b.

Most implementations of terrain following layers use a coordinate system that makes the computational domain rectangular, but introduces metric terms into the equations of motion.  Instead, the model employed in this study uses Cartesian coordinates and non-orthogonal grids.  By doing so, results from the same model can be compared between terrain following and cut cell grids without modifying the equation set or discretisation.

The OpenFOAM utility \texttt{snappyHexMesh} was used to create a grid that approximates the cut cell method.  First, a custom utility was used to move points beneath the surface up to the surface creating small cells near mountain peaks.  Second, the surface faces were taken from the BTF grid and \texttt{snappyHexMesh} was used to intersect the surface with the grid.  This tool removes cells whose centres are below the surface and displaces boundary vertices so that they are `snapped' to the BTF surface \citep{openfoam2015}.  An example of the resulting grid is shown in figure~\ref{fig:grid}c.

There are two details of grid construction which mean that resulting cut cell grids can differ slightly from a typical cut cell grid created using a shaving method, as described by \citet{adcroft1997}.  First, when \texttt{snappyHexMesh} moves vertices onto the terrain surface, some points are moved horizontally.  Second, the utility does not create new points necessary for pentagonal cells.


\section{Models}
\label{sec:model}
Three models are used for the test cases in this study: two linear advection models and a model of the fully-compressible Euler equations.  All are operated in a two-dimensional $x$--$z$ slice configuration.

\subsection{Finite volume linear advection model}
The first model discretises the linear advection equation in flux form:
\begin{align}
\partial \phi / \partial t + \nabla \cdot \left( \mathbf{u} \phi \right) = 0
\label{eq:advect}
\end{align}
where $\mathbf{u} = (u, w)$ is a prescribed velocity field and the tracer density, $\phi$, is interpolated onto cell faces using one of two schemes: first, the centred linear scheme which takes the average of the two neighbouring cell values; second, the upwind-biased multidimensional cubic scheme from \citet{weller-shahrokhi2014} which is non-monotonic and not flux corrected.
The time derivative is solved using a three-stage, second order Runge-Kutta scheme defined as:
\begin{subequations}
\begin{align}
	\phi^\star &= \phi^{(n)} + \Delta t f(\phi^{(n)}) \\
	\phi^{\star\star} &= \phi^{(n)} + \frac{\Delta t}{2} \left( f(\phi^{(n)}) + f(\phi^\star) \right) \\
	\phi^{(n+1)} &= \phi^{(n)} + \frac{\Delta t}{2} \left( f(\phi^{(n)}) + f(\phi^{\star\star}) \right)
\end{align}
\end{subequations}
where \(f(\phi^{(n)}) = - \nabla \cdot (\mathbf{u} \phi^{(n)})\) at time level \(n\). 
To ensure that the discrete velocity field is non-divergent, velocities are prescribed at cell faces by differencing the streamfunction, \(\Psi(x, z)\), along the edges from \(\Psi\) stored at cell vertices.

\subsection{Finite difference linear advection model}
The second model is a modified version of the linear advection model first used by \citet{schaer2002}.  It uses terrain following coordinates and it is configured with leapfrog timestepping and a fourth-order centred difference scheme:
\begin{align}
	\frac{\partial \phi_i}{\partial x} \approx \frac{1}{\Delta x} \left( \frac{1}{12} \phi_{i-2} - \frac{2}{3} \phi_{i-1} + \frac{2}{3} \phi_{i+1} - \frac{1}{12} \phi_{i+2} \right)
\end{align}

Once again, velocity fields are prescribed using a streamfunction defined at cell vertices (referred to as double staggered grid points by \citet{schaer2002}).  The original version of the code interpolated the geometric height, $z$, at doubly staggered points from values at adjacent half levels in order to calculate the streamfunction.  The modified version used here directly calculates the height at vertices to enable comparisons with the finite volume model solutions.

\subsection{Fully-compressible model}
The third model is taken from \citet{weller-shahrokhi2014} which details a discretisation of the fully-compressible Euler equations, given by
\begin{subequations}
\begin{align}
	\text{Momentum} &\ &\  	\frac{\partial \rho \mathbf{u}}{\partial t} + \nabla \cdot \rho \mathbf{u}\otimes\mathbf{u} &= \rho \mathbf{g} - c_p \rho \theta \nabla \Pi - \mu \rho \mathbf{u} \label{eq:momentum} \\
	\text{Continuity} &\ &\	\frac{\partial \rho}{\partial t} + \nabla \cdot \rho \mathbf{u} &= 0 \label{eq:cont} \\
	\text{Thermodynamic equation} &\ &\ \frac{\partial \rho \theta}{\partial t} + \nabla \cdot \rho \mathbf{u} \theta &= 0 \label{eq:theta} \\
	\text{Ideal gas law} &\ &\ \Pi^{(1 - \kappa)/\kappa} &= \frac{R \rho \theta}{p_0} \label{eq:state}
\end{align}
\end{subequations}
where \(\rho\) is the density, \(\mathbf{u}\) is the velocity field, \(\mathbf{g}\) is the gravitational acceleration, \(c_p\) is the heat capacity at constant pressure, \(\theta = T \left(p_0/p\right)^\kappa\) is the potential temperature, \(T\) is the temperature, \(p\) is the pressure, \(p_0\) is a reference pressure, \(\Pi = \left(p / p_0 \right)^\kappa\) is the Exner function of pressure, and \(\kappa = R/c_p\) is the gas constant to heat capacity ratio.  \(\mu\) is a dimensionless damping function used for the sponge layer in the gravity waves test in section~\ref{sec:results}\ref{sec:gw}.

The fully-compressible model uses the C-grid staggering in the horizontal and the Lorenz staggering in the vertical such that $\theta$, $\rho$ and $\Pi$ are stored at cell centroids and the covariant component of velocity at cell faces.  The model is configured without Coriolis forces.

\input{model}

\section{Results}
\label{sec:results}

A series of two-dimensional tests are performed over idealised orography.  For each test, results on the BTF, SLEVE and cut cell grid are compared.  The first test from \citet{schaer2002} advects a tracer in a horizontal velocity field.  Second, a new tracer advection test is formulated employing a terrain following velocity field to challenge the advection scheme on cut cell grids.  The third test solves the Euler equations for a stably stratified atmosphere initially at rest, following \citet{klemp2011}.  Finally, as specified by \citet{schaer2002}, a test of orographically-induced gravity waves is performed.  \TODO{advection of thermal profile} No explicit diffusion is used in any of the tests.

The OpenFOAM implementation of the numerical model, grid generation utilities and test cases are available at \url{https://github.com/hertzsprung/tf-cutcell-comparison/tree/shaw-weller-2015-mwr}.


\subsection{Horizontal advection}

Following \citet{schaer2002}, a tracer is transported above wave-shaped terrain by solving the advection equation for a prescribed horizontal wind.  This test challenges the accuracy of the advection scheme in the presence of grid distortions.

The domain is \SI{301}{\kilo\meter} wide and \SI{25}{\kilo\meter} high, discretized onto a grid with \(\Delta x = \SI{1}{\kilo\meter}\) and \(\Delta z^\star = \SI{500}{\meter}\).  The domain specified by \citet{schaer2002} is \SI{300}{\kilo\meter} between the outermost cell centres where tracer values are specified.  In order to reproduce the result from \citet{schaer2002}, the domain has been extended horizontally by \(\Delta x/2\) \si{\meter} in both directions so that the distance between the outermost cell centres is still \SI{300}{\kilo\meter}.

The terrain is wave-shaped, specified by the surface height, \(h\), such that
\begin{subequations}
\begin{align}
   h(x) &= h^\star \cos^2 ( \alpha x )
%
\intertext{where}
%
   h^\star(x) &= \left\{ \begin{array}{l l}
       h_0 \cos^2 ( \beta x ) & \quad \text{if $| x | < a$} \\
	0 & \quad \text{otherwise}
    \end{array} \right.
\end{align}
\end{subequations}
where $a = \SI{25}{\kilo\meter}$ is the mountain envelope half-width, $h_0 = \SI{3}{\kilo\meter}$ is the maximum mountain height, $\lambda = \SI{8}{\kilo\meter}$ is the wavelength, \(\alpha = \pi / \lambda\) and \(\beta = \pi / (2a)\).  On the SLEVE grid, the large-scale component $h_1$ is given by \(h_1(x) = h^\star(x) / 2\)
and $s_1 = \SI{15}{\kilo\meter}$ is the large scale height, and $s_2 = \SI{2.5}{\kilo\meter}$ is the small scale height.  The optimisation of SLEVE by \citet{leuenberger2010} is not used, so the exponent $n = 1$.

The wind is entirely horizontal and is prescribed as
\begin{align}
	u(z) = u_0 \left\{ \begin{array}{l l}
		1 & \quad \text{if $z \geq z_2$} \\
		\sin^2 \left( \frac{\pi}{2} \frac{z - z_1}{z_2 - z_1} \right) & \quad \text{if $z_1 < z < z_2$} \\
		0 & \quad \text{otherwise}
	\end{array} \right.	
\end{align}
where $u_0 = \SI{10}{\meter\per\second}$, $z_1 = \SI{4}{\kilo\meter}$ and $z_2 = \SI{5}{\kilo\meter}$.
This results in a constant wind above $z_2$, and zero flow at \SI{4}{\kilo\meter} and below.

The discrete velocity field is defined using a streamfunction, \(\Psi\).  Given that \(u = -\partial \Psi / \partial z\), the streamfunction is found by vertical integration of the velocity profile:
\begin{align}
	\Psi(z) &= -\frac{u_0}{2} \left\{ \begin{array}{l l}
		\left( 2z - z_1 - z_2 \right) & \enskip \text{if $z > z_2$} \\
		z - z_1 - \frac{z_2 - z_1}{\pi} \sin \left(\pi \frac{z - z_1}{z_2-z_1}\right) & \enskip \text{if $z_1 < z \leq z_2$} \\
		0 & \enskip \text{if $z \leq z_1$}
	\end{array} \right.
\end{align}

A tracer with density $\phi$ is positioned upstream above the height of the terrain.  It has the shape
\begin{align}
	\phi(x, z) &= \phi_0 \left\{ \begin{array}{l l}
		\cos^2 \left( \frac{\pi r}{2} \right) & \quad \text{if $r \leq 1$} \\
		0 & \quad \text{otherwise}
	\end{array} \right.
%
\intertext{having radius, $r$, given by}
%
	r &= \sqrt{
		\left( \frac{x - x_0}{A_x} \right)^2 + 
		\left( \frac{z - z_0}{A_z} \right)^2
	}
\end{align}
where $A_x = \SI{25}{\kilo\meter}$, $A_z = \SI{3}{\kilo\meter}$ are the horizontal and vertical half-widths respectively, and $\phi_0 = 1$ is the maximum density of the tracer.  At $t = \SI{0}{\second}$, the tracer is centred at $(x_0, z_0) = (\SI{-50}{\kilo\meter}, \SI{9}{\kilo\meter})$ so that the tracer is upwind of the mountain and well above the maximum terrain height of \SI{3}{\kilo\meter}.  Analytic solutions can be found by setting the tracer centre such that $x_0 = ut$.

Unlike \citet{schaer2002} who use periodic lateral boundaries, a fixed value of 0 is used at the inlet boundary and all other boundaries have zero gradient.  Furthermore, a second order Runge-Kutta timestepping scheme is used here instead of the leapfrog scheme used by \citet{schaer2002}.
Tests are integrated forward in time for \SI{10000}{\second} with a timestep of \(\Delta t = \SI{25}{\second}\).

The test was executed on the BTF, SLEVE and cut cell grids, and on a regular grid with flat terrain using a centred linear scheme and the upwind-biased cubic scheme.   Results were also obtained on BTF and SLEVE grids with the fourth order scheme from \citet{schaer2002} using a modified version of their code.

Tracer contours at \(t = \SI{0}{\second}, \SI{5000}{\second}\) and \(\SI{10000}{\second}\) are shown in Figure~\ref{fig:advection-tracer}.
The results are compared on the BTF grid for the centred linear scheme (\ref{fig:advection-tracer}a) and the fourth order scheme from \citet{schaer2002} (\ref{fig:advection-tracer}c), and the upwind-biased cubic scheme on the cut cell grid (\ref{fig:advection-tracer}b), and BTF grid (\ref{fig:advection-tracer}d).  Tracer errors at \(t = \SI{10000}{\second}\) are shown for the fourth order and upwind-biased cubic schemes in figures \ref{fig:advection-tracer}e and \ref{fig:advection-tracer}f respectively.

By \(t = \SI{10000}{\second}\), the tracer suffers from distortion on the BTF grid using the centred linear scheme and some artifacts remain about the mountain peak.  The tracer has spread vertically due to increased numerical errors when the tracer is transported between layers.  Distortions are reduced by using the fourth order scheme from \citet{schaer2002} (figure~\ref{fig:advection-tracer}c), but the computational mode is seen as a grid-scale oscillation that travels in the opposite direction to the wind (figure~\ref{fig:advection-tracer}e).  The results from the centred linear and fourth order schemes are slightly worse than the respective results from \citet{schaer2002} (their figure 6a and figure 8) because of the difference in the discretisation of $\Psi$.

Using the upwind-biased cubic scheme, tracer magnitude and shape are well-preserved on all grids, both above the mountain at \(t = \SI{5000}{\second}\) and past the mountain at \(t = \SI{10000}{\second}\).  In this test, advection is most accurate on the cut cell grid (figure~\ref{fig:advection-tracer}b) and regular grid (not shown).  As found by \citet{good2014}, the result is the same on both grids.  This is to be expected since the wind is zero in the region of the ground and flow aloft is aligned with the grids.  On the BTF grid, the tracer is less distorted by the cubic upwind-biased scheme (figure~\ref{fig:advection-tracer}d) compared to the centred linear scheme (figure~\ref{fig:advection-tracer}a) or fourth order scheme (figure~\ref{fig:advection-tracer}c).

Minimum and maximum tracer values and \(\ell_2\) error norms on the BTF, SLEVE, cut cell and regular grids are summarised in table~\ref{tab:advection}, where the \(\ell_2\) error norm is defined as 
\begin{align}
	\ell_2 &= \sqrt{\frac{\sum_c \left( \phi - \phi_{T} \right)^2 \mathcal{V}_c}{\sum_c \left( \phi_T^2 \mathcal{V}_c \right)}} \label{eqn:l2-error}
\end{align}
where $\phi$ is the numerical tracer value, $\phi_T$ is the analytic value and $\mathcal{V}_c$ is the cell volume.

The results of the cubic upwind-biased scheme on TF and regular grids are comparable with those for the fourth-order centred scheme from \citet{schaer2002}.  Error is largest on the BTF grid with \(\ell_2 = \num{0.107}\) but is significantly reduced on the SLEVE grid with \(\ell_2 = \num{0.0146}\).  The error is approximately halved by changing from the SLEVE grid to the cut cell grid.
Tracer minima and maxima for the centred linear and fourth order schemes are lower than those presented by \citet{schaer2002} because no interpolation is used to calculate the streamfunction.

The centred linear scheme is sensitive to changes in the terrain profile: when the domain width is reduced to \SI{300}{\kilo\meter}, the $\ell_2$ error on the BTF grid rises from \num{0.284} to \num{0.432}.  The same sensitivity is found using terrain following coordinates and centred differences in space and time, as implemented by \citet{schaer2002}.  This sensitivity can be explained by realising that increased non-orthogonality or flow misalignment tends to increase errors.  To measure non-orthogonality, consider the total variation, $TV$, of the discrete terrain profile:
\begin{align}
	TV = \sum_i | h(x_{i+1}) - h(x_i) |
\end{align}
where $x_i$ is the horizontal location of a vertex on the lower boundary.  For a domain width of \SI{301}{\kilo\meter}, $TV = \SI{18095}{\meter}$, but for a width of \SI{300}{\kilo\meter}, $TV = \SI{18964}{\meter}$.
The upwind-biased cubic scheme is less sensitive to the same change, with the $\ell_2$ error decreasing from \num{0.107} to \num{0.104}.

The results of the horizontal advection test show that numerical errors are due either to misalignment of the flow with the grid, or to grid distortions.  Using the upwind-biased cubic scheme, distortions in the grid do not significantly distort the tracer.



\subsection{Terrain following advection}
In the horizontal advection test, results were least accurate on the BTF grid, where the grid was most non-orthogonal and flow was misaligned with the grid layers.  Here, we formulate a new tracer advection test in which the velocity field is everywhere tangential to the basic terrain following coordinate surfaces.  This test determines whether the primary source of numerical error is due to non-orthogonality or misalignment of the flow with grid layers. 

The spatial domain, mountain profile, initial tracer profile and discretisation are the same as those in the horizontal tracer advection test.  The velocity field is defined using a streamfunction, $\Psi$, so that the continuous velocity field is non-divergent and follows the BTF coordinate surfaces given by equation~\ref{eqn:btf} such that
\begin{equation}
	\Psi(x,z) = -u_0 H \frac{z - h}{H - h} \label{eqn:streamfunc-btf}
\end{equation}
where $u_0 = \SI{10}{\meter\per\second}$, which is the horizontal wind speed where $h(x) = 0$.
The horizontal and vertical components of velocity, $u$ and $w$, are then given by
\begin{align}
	u &= -\frac{\partial \Psi}{\partial z} = u_0 \frac{H}{H - h}, \quad w = \frac{\partial \Psi}{\partial x} = u_0 H \frac{\mathrm{d} h}{\mathrm{d} x} \frac{H - z}{\left( H - h \right)^2} \label{eqn:uw-btf} \\
	\frac{\mathrm{d} h}{\mathrm{d} x} &= - h_0 \left[ 
		\beta \cos^2 \left( \alpha x \right) \sin \left( 2 \beta x \right) +
		\alpha \cos^2 \left( \beta x \right) \sin \left( 2 \alpha x \right)
	\right]
\end{align}
Unlike the horizontal advection test, flow extends from the top of the domain all the way to the ground.  The discrete velocity field is calculated using the streamfunction in the same way as the horizontal advection test.

At $t = \SI{10000}{\second}$ the tracer has passed over the mountain.  The horizontal position of the tracer centre can be calculated by integrating along the trajectory to find $t$, the time taken to pass from one side of the mountain to the other:
\begin{align}
	\mathrm{d}t &= \mathrm{d}x / u(x) \\
	t &= \int_0^x \frac{H - h(x)}{u_0 H}\:\mathrm{d}x \\
	t &= \frac{x}{u_0} - \frac{h_0}{16 u_0 H} \left[ 4x + \frac{\sin 2 (\alpha + \beta) x}{\alpha + \beta} \right.+ \nonumber \\
   &\ \left. \frac{\sin 2(\alpha - \beta) x}{\alpha - \beta} + 2 \left( \frac{\sin 2\alpha x}{\alpha} + \frac{\sin 2\beta x}{\beta} \right) \right]
\end{align}
Hence, we find that \(x(t=\SI{10000}{\second}) = \SI{51577.4}{\meter}\).  Because the velocity field is non-divergent, the flow accelerates over mountain ridges and the tracer travels \SI{1577.4}{\meter} further compared to advection in the purely horizontal velocity field.  Tracer height is unchanged downwind of the mountains because advection is along the terrain following coordinate surface.

$\ell_2$ errors and tracer extrema for this test are compared with the horizontal advection results in table~\ref{tab:advection}.  In the terrain following velocity field, tracer accuracy is greatest on the BTF grid.  Using the cubic upwind-biased scheme, errors are about ten times larger on the SLEVE and cut cell grids compared to the BTF grid.

Using the centred linear scheme on the cut cell grid, numerical instability is generated by flow through small cells: when interpolating \(\phi\) onto faces, flux from a large cell into a small cell means that the downwind cell is given greater weighting.  The maximum Courant number is less than one in all of the advection tests, hence it is not the source of this instability.

We conclude from this test that accuracy depends upon alignment of the flow with the grid, and accuracy is not significantly reduced by grid distortions.  Error on the BTF grid in the terrain following advection test is comparable with the error on the SLEVE grid in the horizontal advection test.

\subsection{Stratified atmosphere initially at rest}
\label{sec:resting}

An idealised terrain profile is defined along with a stably stratified atmosphere at rest in hydrostatic balance.  The analytic solution is time-invariant, but numerical errors in calculating the horizontal pressure gradient can give rise to spurious velocities which become more severe over steeper terrain \citep{klemp2011}.

The test setup follows the specification by \cite{klemp2011}.  The domain is \SI{200}{\kilo\meter} wide and \SI{20}{\kilo\meter} high, and the grid resolution is \(\Delta x = \Delta z^\star = \SI{500}{\meter}\).  All boundary conditions are no normal flow.

The wave-shaped mountain profile has a surface height, $h$, given by
\begin{align}
	h(x) = h_0 \exp \left( - \left( \frac{x}{a} \right)^2 \right) \cos^2 \left( \alpha x \right) \label{eqn:resting:mountain}
\end{align}
where $a = \SI{5}{\kilo\meter}$ is the mountain half-width, $h_0 = \SI{1}{\kilo\meter}$ is the maximum mountain height and $\lambda = \SI{4}{\kilo\meter}$ is the wavelength.  For the optimised SLEVE grid, the large-scale component $h_1$ is specified as
\begin{align}
h_1(x) = \frac{1}{2} h_0 \exp \left( - \left( \frac{x}{a} \right)^2 \right)
\end{align}
and, following \cite{leuenberger2010}, $s_1 = \SI{4}{\kilo\meter}$ is the large scale height, $s_2 = \SI{1}{\kilo\meter}$ is the small scale height, and the optimal exponent value of $n = 1.35$ is used.

The initial thermodynamic conditions are in discrete hydrostatic balance, having a reference potential temperature of $\theta(z = 0) = \SI{288}{\kelvin}$ and constant stability with Brunt-V\"ais\"al\"a frequency $N = \SI{0.01}{\per\second}$ everywhere, except for a more stable layer of $N = \SI{0.02}{\per\second}$ between $\SI{2}{\kilo\meter} \leq z \leq \SI{3}{\kilo\meter}$.  The damping function, \(\mu\), is set to zero.  Unlike \citet{klemp2011}, there is no eddy diffusion in the equation set.

The test was integrated forward by 5 hours on the BTF, SLEVE and cut cell grids, and a regular grid with flat terrain.  Maximum vertical velocities are presented in figure~\ref{fig:resting}.  In agreement with \citet{klemp2011}, vertical velocities are larger on more distorted grids.  However, magnitudes are smaller comparing results on the terrain following grids with those from \citet{klemp2011}.  
The results presented in figure~\ref{fig:resting}, which use a curl-free pressure gradient, have maximum spurious values of $w$ of \SI{0.33}{\meter\per\second} on the BTF grid, compared with a maximum of \(\sim \SI{7}{\meter\per\second}\) found by \citet{klemp2011} using their improved horizontal pressure gradient formulation.
The results in figure~\ref{fig:resting} have the same maximum errors as \citet{weller-shahrokhi2014} but, due to the more stable split into implicitly and explicitly treated terms, the errors decay over time due to the dissipative nature of the advection scheme.

Unlike the result from \citet{klemp2011}, the SLEVE grid does not significantly reduce vertical velocities compared to the BTF grid.  However, errors are two orders of magnitude smaller on the cut cell grid with vertical velocities of \(\sim \SI{1e-4}{\meter\per\second}\).  The smallest error of \(\sim \SI{1e-10}{\meter\per\second}\) is found on the regular grid.

\citet{good2014} found the maximum vertical velocity in their cut cell model was \SI{1e-12}{\meter\per\second}, which is better than any result obtained here.  It is worth noting that the model by \citet{weller-shahrokhi2014} stores values at the geometric centre of cut cells.  However, in the model used by \citet{good2014}, cell centres are in the centre of the uncut cell, resulting in the centre of some cut cells being below the ground (S.-J. Lock 2014, personal communication).  This means that the grid is effectively regular when calculating horizontal and vertical gradients.  This would account for the very small velocities found by \citet{good2014}.

In summary, spurious velocities in the resting atmosphere test were similar on both terrain following grids, with lower errors compared to those from \citet{klemp2011}.  The maximum vertical velocity was significantly decreased on the cut cell grid, so we conclude that non-orthogonality, or lack of alignment of the grid with sufaces of constant gravitational potential are a significant cause of numerical error in this test.


\subsection{Gravity waves}
\label{sec:gw}
The test originally specified by \citet{schaer2002} prescribes flow over terrain with small-scale and large-scale undulations which induces propagating and evanescent gravity waves.

Following \citet{melvin2010}, the domain is \SI{300}{\kilo\meter} wide and \SI{30}{\kilo\meter} high with a grid resolution of \(\Delta x = \SI{500}{\meter}\) and \(\Delta z^\star = \SI{300}{\meter}\).  \TODO{we want to consider dz=250m and dz=200m, too} The mountain profile has the same form as equation~\ref{eqn:resting:mountain}.  Tests are performed with mountain heights of $h_0 = \SI{250}{\meter}$ and \(h_0 = \SI{500}{\meter}\).  As in the resting atmosphere test, $a = \SI{5}{\kilo\meter}$ is the mountain half-width and $\lambda = \SI{4}{\kilo\meter}$ is the wavelength.  On the optimised SLEVE grid, $s_1 = \SI{5}{\kilo\meter}$ is the large scale height, $s_2 = \SI{2}{\kilo\meter}$ is the small scale height and the optimal exponent value $n = 1.35$ is used.

The initial thermodynamic conditions have a surface temperature of $\theta(z=0) = \SI{288}{\kelvin}$ and constant stability with $N = \SI{0.01}{\per\second}$ everywhere.  A uniform horizontal wind $u = \SI{10}{\meter\per\second}$ is prescribed at the inlet boundary.

Sponge layers are added to the upper \SI{10}{\kilo\meter} and leftmost \SI{10}{\kilo\meter} at the inlet boundary to damp the reflection of waves.
The damping function, \(\mu\), is adapted from \citet{melvin2010} such that
\begin{align}
	\mu(x, z) &= \mu_\mathrm{upper} + \mu_\mathrm{inlet} \\
	\mu_\mathrm{upper}(z) &= \begin{cases}
		\overline{\mu} \sin^2 \left( \frac{\pi}{2} \frac{z - z_B}{H - z_B} \right) & \text{if } z \geq z_B \\
		0 & \text{otherwise} \\
	\end{cases} \\
	\mu_\mathrm{inlet}(x) &= \begin{cases}
		\overline{\mu} \sin^2 \left( \frac{\pi}{2} \frac{x_I - x}{x_I - x_0} \right) & \text{if } x < x_I \\
		0 & \text{otherwise}
	\end{cases}
\end{align}
where $\overline{\mu} = 1.2$ is the damping coefficient, $z_B = \SI{20}{\kilo\meter}$ is the bottom of the sponge layer, $H = \SI{30}{\kilo\meter}$ is the top of the domain, $x_0 = \SI{-150}{\kilo\meter}$ is the leftmost limit of the domain and $x_I = \SI{-140}{\kilo\meter}$ is the rightmost extent of the inlet sponge layer.  The sponge layer is only active on faces whose normal is vertical so that it damps vertical momentum only.

Note that, while the domain itself is \SI{30}{\kilo\meter} in height, for the purposes of generating BTF and SLEVE grids, the domain height is set to \SI{20}{\kilo\meter} because the sponge layer occupies the uppermost \SI{10}{\kilo\meter}.

No normal flow is imposed at the top and bottom boundaries and the outlet has a zero gradient boundary condition.  For the Exner function of pressure, hydrostatic balance is prescribed on all boundaries.  The simulation is integrated forward by 5 hours with a timestep $\Delta t = \SI{8}{\second}$.

Test results are compared between the BTF, SLEVE and cut cell grids.  Vertical velocities on the BTF, SLEVE and cut cell grids are visually indistinguishable (not shown).  They agree with the high resolution mass-conserving semi-implicit semi-Lagrangian solution from \citet{melvin2010}.

The initial thermal profile is subtracted from the potential temperature field at the end of the integration to reveal the structure of thermal anomalies.  Once again, the results are similar on all three grids, and results are shown on the BTF and cut cell grids in figures~\ref{fig:gw-theta}a and \ref{fig:gw-theta}c respectively.  However, examining more closely the anomalies in the lee of the mountain for the cut cell grid, figure~\ref{fig:gw-theta}d shows that the bottommost layer is anomalously warm and the layer above it is anomalously cold.  This feature is not present on the BTF grid (figure~\ref{fig:gw-theta}b) or the SLEVE grid (not shown).  \TODO{not present?  I think it is, just much smaller amplitude}

To summarize, results of the gravity waves test on all grids are in good agreement with the reference solution from \citet{melvin2010}.

\subsection{Terrain following advection of thermal profile}
The spatial domain, mountain profile, grid resolutions and timesteps are the same as those in the gravity waves test in section~\ref{sec:results}\ref{sec:gw}.  The terrain following velocity field is defined by the streamfunction:
\begin{align}
	\Psi(x,z) = -u_0 \left\{ \begin{array}{l l}
			H_\mathrm{TF} \frac{z - h}{H_\mathrm{TF} - h} & \enskip \text{if $z \leq H_\mathrm{TF}$} \\
			z & \enskip \text{if $z > H_\mathrm{TF}$}
	\end{array} \right.
\end{align}
where \(H_\mathrm{TF} = \SI{20}{\kilo\meter}\) is the level at which the terrain following layers become flat; the domain height is \(\SI{30}{\kilo\meter}\).
For $z \leq H$, the $u$ and $w$ components of velocity are given by equation~\ref{eqn:uw-btf}, but $h(x)$ has the same form as equation~\ref{eqn:resting:mountain}, hence the derivative is:
\begin{align}
	\frac{\mathrm{d} h}{\mathrm{d} x} = -h_0 \exp \left(- \left( \frac{x}{a} \right)^2 \right) \left[ \frac{\pi}{\lambda} \sin \left( \frac{2 \pi x}{\lambda} \right) - \frac{2x}{a^2} \cos^2\left( \frac{\pi x}{\lambda} \right) \right]
\end{align}
For $z > H$, $u = u_0$ and $w = 0$.

The tracer field, \(\phi\), is the same as the initial potential temperature field in the gravity waves test:
\begin{align}
	\phi(z) = \phi_0 \exp \left( \frac{N^2}{g} z \right) \label{eqn:thermal-tracer}
\end{align}
where \(\phi_0 = 288\) and \(N = \SI{0.01}{\per\second}\).  The inlet boundary has fixed values prescribed by equation~\ref{eqn:thermal-tracer} and a zero gradient boundary condition is applied at the outlet.

\section{Conclusions}
We have presented a like-for-like comparison between terrain following and cut cell grids using a single model.  Accuracy on the BTF, SLEVE and cut cell grids was evaluated in a series of two-dimensional tests.

Across all tests, a high degree of accuracy was achieved for all grids.  Even on the highly-distorted BTF grid, which have previously been found to give poor results \citep{schaer2002,klemp2011,good2014}, errors were often small in the tests presented here.  In the first two tests, tracers were advected by horizontal and terrain following velocity fields.  We found that the accuracy of the upwind-biased cubic advection scheme depended upon alignment of the flow with the grid rather than on grid distortions.

Spurious vertical velocities were small in the resting initial state test, reaching a maximum of $\sim \SI{0.35}{\meter\per\second}$ on the BTF grid, compared to a maximum of $\sim \SI{7}{\meter\per\second}$ found by \citet{klemp2011}.  In the gravity waves test, vertical velocities were in good agreement with the reference solution from \citet{melvin2010} across all grids.

Cut cell grids reduced errors in two of the four tests.  First, in the horizontal advection test, tracer accuracy on the cut cell grid was almost as good as accuracy on a regular grid with no mountain.  Second, in the resting atmosphere test, spurious vertical velocities were two orders of magnitude smaller on the cut cell grid compared with the terrain folllowing grids.

Conversely, in the terrain following advection test, errors were large on the SLEVE and cut cell grids where velocities were misaligned with the grids.

\acknowledgments
I am grateful to my co-supervisors John Methven and Terry Davies for their valuable input, and to Christoph Sch\"{a}r (ETH) for his assistance in reproducing his advection test results.  I am thankful for the NERC studentship which helped fund this work.  Weller is funded by NERC grant NE/H015698/1.

%% APPENDICES
\begin{appendices}
\input{WellerAppendix}
\end{appendices}


% REFERENCES

\bibliographystyle{ametsoc2014}
\bibliography{references}

% TABLES
\begin{table*}
	\caption{Minimum and maximum tracer magnitudes and \(\ell_2\) error norms (defined by equation~\ref{eqn:l2-error}) at \(t = \SI{10000}{\second}\) in the horizontal and terrain following tracer advection tests using centred linear and cubic upwind-biased schemes.  For the horizontal advection test, \(\ell_2\) error norms, minimum and maximum values are given for the fourth order scheme using the modified code from \citet{schaer2002}.}
\label{tab:advection}
%
\centering
\footnotesize
\begin{tabular}{l l l l S S S S}
\hline\hline
                  &                     &                  & Analytic & {BTF}   & {SLEVE}         & {Cut cell}     & {No terrain} \\
\hline
Horizontal        & Centred linear      & \(\ell_2\) error & 0        & 0.284   & 0.0316          & 0.0304         & 0.0304      \\
                  &                     & min              & 0        & -0.275  & -0.0252         & -0.0251        & -0.0251     \\
                  &                     & max              & 1        & 0.925   & 0.985           & 0.985          & 0.985       \\
                  & Fourth order        & \(\ell_2\) error & 0        & 0.0938  & 0.00244         & {---}          & 0.00234     \\
                  &                     & min              & 0        & -0.0926 & -0.00174        & {---}          & -0.00178    \\
                  &                     & max              & 1        & 1.00    & 0.984           & {---}          & 0.983       \\
                  & Cubic upwind-biased & \(\ell_2\) error & 0        & 0.107   & 0.0146          & 0.00784        & 0.00784     \\
                  &                     & min              & 0        & -0.0446 & -0.0106         & -0.000674      & -0.00674    \\
                  &                     & max              & 1        & 0.925   & 0.982           & 0.983          & 0.983       \\
\hline
Terrain following & Centred linear      & \(\ell_2\) error & 0        & 0.0341  & 0.235           & {unstable}     & {---}        \\
	          &                     & min              & 0        & -0.0245 & -0.120          & {unstable}     & {---}        \\
		  &                     & max              & 1        & 0.985   & 0.950           & {unstable}     & {---}        \\
		  & Cubic upwind-biased & \(\ell_2\) error & 0        & 0.0209  & 0.162           & 0.181          & {---}        \\
                  &                     & min              & 0        & -0.0110 & -0.0263         & -0.028         & {---}        \\
                  &                     & max              & 1        & 0.983   & 0.865           & 0.851          & {---}        \\
\hline
\end{tabular}
\end{table*}


% FIGURES
\begin{figure*}
	\centering
	\includegraphics{../fig-meshes/fig-meshes.pdf}
	%
	\caption{Examples of (a) BTF, (b) SLEVE, and (c) a cut cell grid, showing cell edges in the lowest four layers.  The full two dimensional grids are \SI{20}{\kilo\meter} wide and \SI{20}{\kilo\meter} high.  SLEVE parameters are specified in the resting atmosphere test in section~\ref{sec:results}\ref{sec:resting}.  The cut cell grid was created by intersecting the terrain surface with a regular grid as described in section~\ref{sec:grid}.  Axes are in units of \si{\meter}.}
	\label{fig:grid}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics{../fig-advection-tracer/fig-advection-tracer.pdf}
%
	\caption{Horizontally advected tracer contours at \(t = \SI{0}{\second}\), \SI{5000}{\second} and \SI{10000}{\second} using (a) centred linear scheme on the BTF grid, (b) the upwind-biased cubic scheme on the cut cell grid, (c) the fourth order scheme from \citet{schaer2002} on the BTF grid, and (d) the upwind-biased cubic scheme on the BTF grid with contour intervals every 0.1.  Errors on the BTF grid at \(t = \SI{10000}{\second}\) are shown for (e) the fourth order scheme from \citet{schaer2002}, and (f) the upwind-biased cubic scheme, with contour intervals every 0.01.  Negative contours denoted by dotted lines.  The terrain profile is also shown immediately above the $x$ axis.  Subfigures (c) and (e) produced using the modified version of the code from \citet{schaer2002}.}
	\label{fig:advection-tracer}
\end{figure*}

\begin{figure}
	\centering
	\includegraphics{../fig-resting/fig-resting.pdf}
%
	\caption{Maximum spurious vertical velocity, \(w\) (\si{\meter\per\second}), in the resting atmosphere test with results on BTF, SLEVE, cut cell and regular grids using the model from \citet{weller-shahrokhi2014} which includes a curl-free pressure gradient formulation.}
	\label{fig:resting}
\end{figure}

\begin{figure*}
	\centering
	\includegraphics{../fig-gravityWaves-theta/fig-gravityWaves-theta.pdf}
%
	\caption{Anomalies in potential temperature in the gravity waves test after 5 hours with a mountain height, \(h_0 = \SI{250}{\meter}\).  The central domain in the lowest \SI{12}{\kilo\meter} is shown on (a) the BTF grid, and (c) the cut cell grid.  The four lowest layers of each grid are shown for (b) BTF, and (d) cut cell grids, using a narrower potential temperature scale.  The results on the SLEVE grid (not shown) are qualitatively identical to results on the BTF grid.  Axes are in units of \si{\meter}.}
	\label{fig:gw-theta}
\end{figure*}

\end{document}
