\documentclass{ametsoc}

\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{siunitx}
\usepackage[title]{appendix}

\bibpunct{(}{)}{;}{a}{}{,}

\newcommand{\TODO}[1]{\textcolor{purple}{TODO: \emph{#1}}}

\title{Comparison of Terrain Following and Cut Cell Grids using a Non-Hydrostatic Model}
\authors{James Shaw\correspondingauthor{Department of Meteorology, University of Reading, Earley Gate, PO Box 243, Reading, RG6 6BB, UK.} and Hilary Weller}
\affiliation{Department of Meteorology, University of Reading, Reading, United Kingdom}
\email{js102@zepler.net}


\abstract{Terrain following coordinates are widely used in operational models but the cut cell method has been proposed as an alternative that can more accurately represent atmospheric dynamics over steep orography.  Because the type of grid is usually chosen during model implementation, it is typically necessary to use different models in order to compare the accuracy of different grids.  In contrast, here a single C-grid finite volume model is used to enable a like-for-like comparison of terrain following and cut cell grids.
A series of standard two-dimensional tests using idealised terrain are performed: tracer advection in a prescribed horizontal velocity field, a test starting from stably stratified initial conditions, and orographically induced gravity waves described by nonhydrostatic dynamics.  In addition, two new advection tests are formulated having a velocity field that is everywhere tangential to the terrain following coordinate surfaces.  These new tests present a challenge to the advection scheme on cut cell grids.
The results of the advection tests demonstrate that accuracy depends primarily upon alignment of the flow with the grid rather than the grid orthogonality.  As expected, the cut cell grid maintains greater accuracy for horizontal advection and in the test of stationary, stratified flow.  In the gravity waves test, results on all grids are in good agreement with existing results from the literature, although terrain following velocity fields lead to errors on cut cell grids.
Due to semi-implicit timestepping and an upwind-biased, explicit advection scheme, there were no timestep restrictions associated with small cut cells.}

\begin{document}

\maketitle

\section{Introduction}
Representing orography accurately in numerical weather prediction systems is necessary to model downslope winds and local precipitation.  Orography also exerts strong non-local influences: from the latent heat release due to convection, by directly forcing gravity waves and planetary waves, and by the atmospheric response to form drag and gravity wave drag.  There are two main approaches to representing orography on a grid: terrain following layers and cut cells, with the immersed (or embedded) boundary method \citep{simon2012} being similar to a cut cell approach.  All methods align cells in vertical columns.  Most models are designed for a particular type of grid, and the study by \citet{good2014} compared cut cell results with terrain following solutions implemented within different models.  Instead, this study uses a single model to enable a like-for-like comparison between solutions using terrain following and cut cell grids.

With increasing horizontal model resolution, the discrete representation of terrain can become steeper, making accurate calculation of the horizontal pressure gradient more difficult when using terrain following layers \citep{gary1973,steppeler2002}.  Numerical errors in this calculation result in spurious winds and can cause numerical instability \citep{fast2003,webster2003}.  Cut cell methods seek to reduce the error that is associated with steep orography.

With terrain following (TF) layers the terrain's influence decays with height so that the bottommost layers follow the underlying surface closely while the uppermost layers are flat.  There are two main approaches to minimizing errors associated with TF layers.  First, by smoothing the effects of terrain with height, the influence of the terrain is reduced, hence errors in the calculated horizontal pressure gradient are also reduced aloft \citep{schaer2002,leuenberger2010,klemp2011}.  However, the error is not reduced at the ground where steep terrain remains unmodified.

Second, numerical errors can also be reduced by improving the accuracy in calculating the horizontal pressure gradient itself.  TF layers are usually implemented using a coordinate transformation onto a rectangular computational domain, which introduces metric terms into the equations of motion.  The techniques proposed by \citet{klemp2011} and \cite{zaengl2012} both involve interpolation onto $z$-levels in order to calculate the horizontal pressure gradient.  This gave them the flexibility to design more accurate horizontal pressure gradient discretizations using more appropriate stencils.
The technique proposed by \citet{weller-shahrokhi2014} involved calculating pressure gradients in the direction aligned with the grid, thus ensuring curl-free pressure gradients and improving accuracy.

Despite their associated numerical errors, TF layers are in widespread operational use \citep{steppeler2003}.  They are attractive because their rectangular structure is simple to process by computer and link with parameterisations, and boundary layer resolution can be increased with variable spacing of vertical layers \citep{schaer2002}.

Cut cells is an alternative method in which the grid does not follow the terrain but, instead, cells that lie entirely below the terrain are removed, and those that intersect the surface are modified in shape so that they more closely fit the terrain.  The resulting grid is orthogonal everywhere except near cells that have been cut.  Hence, errors are still introduced when calculating the horizontal pressure gradient between cut and uncut cells.

The cut cell method can create some very small cells which reduce computational efficiency \citep{klein2009}, and several approaches have been tried to alleviate the problem.  \citet{yamazaki-satomura2010} combine small cells with horizontally or vertically adjacent cells.  \citet{steppeler2002} employ a thin-wall appoximation to increase the computational volume of small cells without altering the terrain.  \citet{jebens2011} avoid the timestep restriction associated with explicit schemes by using an implicit method for cut cells and a semi-explicit method elsewhere.

Some studies have shown examples where cut cells produce more accurate results when compared to TF coordinates.  Spurious winds seen in TF coordinates are not present with cut cells and errors do not increase with steeper terrain \citep{good2014}.  A comparison of TF and cut cells using real initial data by \citet{steppeler2013} found that five-day forecasts of precipitation and wind over Asia in January 1989 were more accurate in the cut cell model, although this result was dependent on using an old version of a model.

Another alternative method is the eta coordinate, described by \citet{mesinger1988}.  This transformation, expressed in pressure coordinates, quantises the surface pressure at each grid box using prescribed geometric heights.  This results in terrain profiles having a staircase pattern which is known as `step' orography.  The eta coordinate improves the accuracy of the horizontal pressure gradient calculation compared to the sigma coordinate \citep{mesinger1988}.

In an experiment of orographically induced gravity waves, \citet{gallus-klemp2000} found that horizontal flow along the lee slope was artificially weak in the Eta model.  \citet{mesinger2012} offer an explanation for this behaviour: air flowing along the lee slope cannot travel diagonally downwards but must first travel horizontally, then vertically downward.  However, lee slope winds are weakened because some of the air continues to be transported horizontally aloft.

\citet{mesinger2012} refined the formulation to allow diagonal transport of momentum and temperature immediately above sloping terrain.  This arrangement is similar to the finite volume cut cell method.  The new method improved test results, increasing lee slope winds by \SIrange{4}{5}{\meter\per\second} \citep{mesinger2012}.

This study uses a modified version of the fully-compressible model from \citet{weller-shahrokhi2014} to enable a like-for-like comparison between terrain following and cut cell grids for idealised, two-dimensional test cases from the literature.  Section 2 presents the formulation of the terrain following and cut cell grids used in the experiments that follow.  In section 3 we give the governing equations, outline the model from \citet{weller-shahrokhi2014} and describe the modification which improves stability for long timesteps in the presence of steep orography.  Section 4 analyses the results from three advection tests, a test of a stably stratified atmosphere initially at rest, and orographically induced gravity waves.  Concluding remarks are made in section 5.


\section{Grids}
\label{sec:grid}

Here we describe the formulation of the terrain following grids and the method of cut cell grid construction.  The techniques presented are used to define the grids for the experiments in section~\ref{sec:results}.

\citet{galchen-somerville1975} proposed a basic terrain following (BTF) coordinate defined as 
\begin{equation}
	z = \left( H - h \right) \left( z^\star / H \right) + h \label{eqn:btf}
\end{equation}
where, in two dimensions, \(z(x, z^\star)\) is the physical height of the Cartesian coordinate surface at the model level with transformed height \(z^\star\), \(H\) is the height of the domain, and \(h(x)\) is the height of the terrain surface.  In this formulation $z$ varies between $h$ and $H$ and $z^\star$ ranges from 0 to $H$.  Using this coordinate, the terrain's influence decays linearly with height but disappears only at the top of the domain.  An example is shown in figure~\ref{fig:grid}a.

The smooth level vertical (SLEVE) coordinate proposed by \citet{schaer2002} achieves a more regular TF grid in the middle and top of the domain than the BTF coordinate.  The terrain height is split into large-scale and small-scale components, \(h_1\) and \(h_2\), such that \(h = h_1 + h_2\), with each component having a different exponential decay. The transformation is defined as 
\begin{align}
	z &= z^\star + h_1 b_1 + h_2 b_2
\intertext{where the vertical decay functions are given by}
	b_i &= \frac{\sinh \left( \left( H / s_i \right)^n - \left( z^\star / s_i \right)^n \right)}{\sinh \left( H / s_i \right)^n}
\end{align}
and \(s_1\) and \(s_2\) are the scale heights of large-scale and small-scale terrain respectively.  The exponent \(n\) was introduced by \citet{leuenberger2010} in order to increase cell thickness in the layers nearest the ground, allowing longer timesteps.  \citet{leuenberger2010} found the exponent has an optimal value of \(n = 1.35\).  Choosing \(n = 1\) gives the decay functions used by \citet{schaer2002}.  An example of the SLEVE grid can be seen in figure~\ref{fig:grid}b.

Most implementations of terrain following layers use a coordinate system that makes the computational domain rectangular, but introduces metric terms into the equations of motion.  Instead, the model employed in this study uses Cartesian coordinates and non-orthogonal grids.  By doing so, results from the same model can be compared between terrain following and cut cell grids without modifying the equation set or discretisation.

Cut cell grids are generated in a different way to the typical shaving technique described by \citet{adcroft1997}.  Starting from a uniform grid, all cell vertices that lie beneath the orography are moved up to the surface.  Additionally, to avoid creating very thin cells, all vertices up to $\Delta z/5$ above the orography are moved down to the surface.
Where all four of a cell's vertices are moved, the cell has zero volume and so it is removed.  Where two vertices at the same horizontal location are moved up to the surface they will occupy the same point; this results in a zero-length edge that is removed to create a triangular cell.  Figure~\ref{fig:grid-generation} shows how a $2 \times 2$-cell, uniform grid is transformed into a cut cell grid.  Cell $c_4$ is removed because it has zero volume, and the zero-length edge at point $p$ is removed to create a triangular cell, $c_3$.

Some thin cells are generated but, unlike most cut cell grids, cells are typically made smaller in height but their width is unaltered.  A grid that has these thin cells can be seen in figure~\ref{fig:gw-meshes}c.  This technique has the advantage that cells are not shortened in the direction of flow and so there should be no additional constraints on the advective Courant number.


\section{Models}
\label{sec:model}
Three models are used for the test cases in this study: two linear advection models and a model of the fully-compressible Euler equations.  All are operated in a two-dimensional $x$--$z$ slice configuration.  

The two finite volume models make use of the upwind-biased multidimensional cubic advection scheme from \citet{weller-shahrokhi2014} which is non-monotonic and not flux corrected.  
The scheme uses a least-squares approach to fit a multidimensional polynomial over an upwind-biased stencil which contains more cells than the number of polynomial coefficients.
This fit is used to interpolate cell values onto face values for discretisation of the advection term using Guass's divergence theorem.
Following \cite{lashley2002} and \cite{weller2009},  the two cells either side of the face we are interpolating onto are weighted in the least squares fit so that the fit goes nearly exactly through these cell centres but does not go exactly through the other points.
This method worked well when used for terrain following meshes by \citet{weller-shahrokhi2014} but can be unstable in the presence of very small cut cells. This is because the least squares fit can generate a larger interpolation weight for the downwind cell than the upwind cell. In order to overcome this problem, wherever a large downwind cell interpolation weight is calculated by the least-squares fit, the weighting of the upwind cell is increased for the least-squares fitting and the fit is re-calculated.
This procedure is repeated until the interpolation weight of the upwind cell is greater than the interpolation weight of the downwind cell. More details of this approach and a study of its behaviour is the subject of a future publication. 


\subsection{Finite volume linear advection model}
The first model discretises the linear advection equation in flux form:
\begin{align}
\partial \phi / \partial t + \nabla \cdot \left( \mathbf{u} \phi \right) = 0
\label{eq:advect}
\end{align}
where $\mathbf{u} = (u, w)$ is a prescribed velocity field and the tracer density, $\phi$, is interpolated onto cell faces using one of two schemes: first, the centred linear scheme which takes the average of the two neighbouring cell values; second, the upwind-biased cubic scheme.
The time derivative is solved using a three-stage, second order Runge-Kutta scheme defined as:
\begin{subequations}
\begin{align}
	\phi^\star &= \phi^{(n)} + \Delta t f(\phi^{(n)}) \\
	\phi^{\star\star} &= \phi^{(n)} + \frac{\Delta t}{2} \left( f(\phi^{(n)}) + f(\phi^\star) \right) \\
	\phi^{(n+1)} &= \phi^{(n)} + \frac{\Delta t}{2} \left( f(\phi^{(n)}) + f(\phi^{\star\star}) \right)
\end{align}
\end{subequations}
where \(f(\phi^{(n)}) = - \nabla \cdot (\mathbf{u} \phi^{(n)})\) at time level \(n\).  This time-stepping scheme is used for consistency with the trapezoidal implicit scheme used for the fully-compressible model, described in section~\ref{sec:model}\ref{sec:euler-model}.
To ensure that the discrete velocity field is non-divergent, velocities are prescribed at cell faces by differencing the streamfunction, \(\Psi(x, z)\), along the edges from \(\Psi\) stored at cell vertices.

\subsection{Finite difference linear advection model}
The second model is a modified version of the linear advection model first used by \citet{schaer2002}.  It uses terrain following coordinates and it is configured with leapfrog timestepping and either second-order centred differences, or a fourth-order centred difference scheme given by:
\begin{subequations}
\begin{align}
	\frac{\partial u \phi}{\partial x} &\approx \frac{1}{\Delta x} \left( u_{i+\frac{1}{2}} F_{i+\frac{1}{2}} - u_{i - \frac{1}{2}} F_{i - \frac{1}{2}}\right) \\
	F_{i+\frac{1}{2}} &= \frac{1}{12} \left( - \phi_{i+2} + 7 \phi_{i+1} + 7 \phi_i - \phi_{i-1} \right)
\end{align}
\end{subequations}
and similarly for \(\partial (w \phi) / \partial z\).

Once again, velocity fields are prescribed using a streamfunction defined at cell vertices (referred to as double staggered grid points by \citet{schaer2002}).  The original version of the code effectively smoothed the orography, interpolating the geometric height, $z$, at doubly staggered points from values at adjacent half levels in order to calculate the streamfunction.  The modified version used here directly calculates the height at vertices to enable comparisons with the finite volume model solutions.

\subsection{Finite volume fully-compressible model}
\label{sec:euler-model}
The third model is taken from \citet{weller-shahrokhi2014} which details a discretisation of the fully-compressible Euler equations, given by
\begin{subequations}
\begin{align}
	\text{Momentum} &\ &\  	\frac{\partial \rho \mathbf{u}}{\partial t} + \nabla \cdot \rho \mathbf{u}\otimes\mathbf{u} &= \rho \mathbf{g} - c_p \rho \theta \nabla \Pi - \mu \rho \mathbf{u} \label{eq:momentum} \\
	\text{Continuity} &\ &\	\frac{\partial \rho}{\partial t} + \nabla \cdot \rho \mathbf{u} &= 0 \label{eq:cont} \\
	\text{Thermodynamic equation} &\ &\ \frac{\partial \rho \theta}{\partial t} + \nabla \cdot \rho \mathbf{u} \theta &= 0 \label{eq:theta} \\
	\text{Ideal gas law} &\ &\ \Pi^{(1 - \kappa)/\kappa} &= \frac{R \rho \theta}{p_0} \label{eq:state}
\end{align}
\end{subequations}
where \(\rho\) is the density, \(\mathbf{u}\) is the velocity field, \(\mathbf{g}\) is the gravitational acceleration, \(c_p\) is the heat capacity at constant pressure, \(\theta = T \left(p_0/p\right)^\kappa\) is the potential temperature, \(T\) is the temperature, \(p\) is the pressure, \(p_0 = \SI{1000}{\hecto\pascal}\) is a reference pressure, \(\Pi = \left(p / p_0 \right)^\kappa\) is the Exner function of pressure, and \(\kappa = R/c_p\) is the gas constant to heat capacity ratio.  \(\mu\) is a damping function used for the sponge layer in the gravity waves test in section~\ref{sec:results}\ref{sec:gw}.

The fully-compressible model uses the C-grid staggering in the horizontal and the Lorenz staggering in the vertical such that $\theta$, $\rho$ and $\Pi$ are stored at cell centroids and the covariant component of velocity at cell faces.  The model is configured without Coriolis forces.

\input{model}

\section{Results}
\label{sec:results}

A series of two-dimensional tests are performed over idealised orography.  For each test, results on terrain following and cut cell grids are compared.  The first test from \citet{schaer2002} advects a tracer in a horizontal velocity field.  Second, a new tracer advection test is formulated employing a terrain following velocity field to challenge the advection scheme on cut cell grids.  The third test solves the Euler equations for a stably stratified atmosphere initially at rest, following \citet{klemp2011}.  Fourth, as specified by \citet{schaer2002}, a test of orographically-induced gravity waves is performed.  Finally, another advection test is formulated that transports a stably stratified thermal profile in a terrain following velocity field.
No explicit diffusion is used in any of the tests.

The OpenFOAM implementation of the numerical model, grid generation utilities and test cases are available at \url{https://github.com/hertzsprung/tf-cutcell-comparison/tree/shaw-weller-2015-mwr}.


\subsection{Horizontal advection}

Following \citet{schaer2002}, a tracer is transported above wave-shaped terrain by solving the advection equation for a prescribed horizontal wind.  This test challenges the accuracy of the advection scheme in the presence of grid distortions.

The domain width is \SI{301}{\kilo\meter}, taken as the horizontal distance between the inlet and outlet boundaries.  The domain is \SI{25}{\kilo\meter} high, discretized onto a grid with \(\Delta x = \SI{1}{\kilo\meter}\) and \(\Delta z^\star = \SI{500}{\meter}\).  Note that \citet{schaer2002} measured the domain width as \SI{300}{\kilo\meter} between the outermost cell centres where tracer values are specified.  The two domain sizes are equivalent irrespective of the measure.

The terrain is wave-shaped, specified by the surface height, \(h\), such that
\begin{subequations}
\begin{align}
   h(x) &= h^\star \cos^2 ( \alpha x )
%
\intertext{where}
%
   h^\star(x) &= \left\{ \begin{array}{l l}
       h_0 \cos^2 ( \beta x ) & \quad \text{if $| x | < a$} \\
	0 & \quad \text{otherwise}
    \end{array} \right.
\end{align}
\end{subequations}
where $a = \SI{25}{\kilo\meter}$ is the mountain envelope half-width, $h_0 = \SI{3}{\kilo\meter}$ is the maximum mountain height, $\lambda = \SI{8}{\kilo\meter}$ is the wavelength, \(\alpha = \pi / \lambda\) and \(\beta = \pi / (2a)\).  On the SLEVE grid, the large-scale component $h_1$ is given by \(h_1(x) = h^\star(x) / 2\)
and $s_1 = \SI{15}{\kilo\meter}$ is the large scale height, and $s_2 = \SI{2.5}{\kilo\meter}$ is the small scale height.  The optimisation of SLEVE by \citet{leuenberger2010} is not used, so the exponent $n = 1$.

The wind is entirely horizontal and is prescribed as
\begin{align}
	u(z) = u_0 \left\{ \begin{array}{l l}
		1 & \quad \text{if $z \geq z_2$} \\
		\sin^2 \left( \frac{\pi}{2} \frac{z - z_1}{z_2 - z_1} \right) & \quad \text{if $z_1 < z < z_2$} \\
		0 & \quad \text{otherwise}
	\end{array} \right.	
\end{align}
where $u_0 = \SI{10}{\meter\per\second}$, $z_1 = \SI{4}{\kilo\meter}$ and $z_2 = \SI{5}{\kilo\meter}$.
This results in a constant wind above $z_2$, and zero flow at \SI{4}{\kilo\meter} and below.

The discrete velocity field is defined using a streamfunction, \(\Psi\).  Given that \(u = -\partial \Psi / \partial z\), the streamfunction is found by vertical integration of the velocity profile:
\begin{align}
	\Psi(z) &= -\frac{u_0}{2} \left\{ \begin{array}{l l}
		\left( 2z - z_1 - z_2 \right) & \enskip \text{if $z > z_2$} \\
		z - z_1 - \frac{z_2 - z_1}{\pi} \sin \left(\pi \frac{z - z_1}{z_2-z_1}\right) & \enskip \text{if $z_1 < z \leq z_2$} \\
		0 & \enskip \text{if $z \leq z_1$}
	\end{array} \right.
\end{align}

A tracer with density $\phi$ is positioned upstream above the height of the terrain.  It has the shape
\begin{align}
	\phi(x, z) &= \phi_0 \left\{ \begin{array}{l l}
		\cos^2 \left( \frac{\pi r}{2} \right) & \quad \text{if $r \leq 1$} \\
		0 & \quad \text{otherwise}
	\end{array} \right.
%
\intertext{having radius, $r$, given by}
%
	r &= \sqrt{
		\left( \frac{x - x_0}{A_x} \right)^2 + 
		\left( \frac{z - z_0}{A_z} \right)^2
	}
\end{align}
where $A_x = \SI{25}{\kilo\meter}$, $A_z = \SI{3}{\kilo\meter}$ are the horizontal and vertical half-widths respectively, and $\phi_0 = \SI{1}{\kilogram\per\meter\cubed}$ is the maximum density of the tracer.  At $t = \SI{0}{\second}$, the tracer is centred at $(x_0, z_0) = (\SI{-50}{\kilo\meter}, \SI{9}{\kilo\meter})$ so that the tracer is upwind of the mountain and well above the maximum terrain height of \SI{3}{\kilo\meter}.  Analytic solutions can be found by setting the tracer centre such that $x_0 = ut$.
Tests are integrated forward in time for \SI{10000}{\second} with a timestep of \(\Delta t = \SI{25}{\second}\).

The test was executed on the BTF, SLEVE and cut cell grids, and on a regular grid with flat terrain using a centred linear scheme and the upwind-biased cubic scheme.   Results were also obtained on BTF and SLEVE grids with the fourth order scheme from \citet{schaer2002} using the modified version of their code.

Minimum and maximum tracer values and \(\ell_2\) error norms on the BTF, SLEVE, cut cell and regular grids are summarised in table~\ref{tab:advection}, where the \(\ell_2\) error norm is defined as 
\begin{align}
	\ell_2 &= \sqrt{\frac{\sum_c \left( \phi - \phi_{T} \right)^2 \mathcal{V}_c}{\sum_c \left( \phi_T^2 \mathcal{V}_c \right)}} \label{eqn:l2-error}
\end{align}
where $\phi$ is the numerical tracer value, $\phi_T$ is the analytic value and $\mathcal{V}_c$ is the cell volume.

The results of the cubic upwind-biased scheme on TF and regular grids are comparable with those for the fourth-order centred scheme from \citet{schaer2002}.  Error is largest on the BTF grid with \(\ell_2 = \num{0.112}\) but is significantly reduced on the SLEVE grid with \(\ell_2 = \num{0.0146}\).
Advection is most accurate on the cut cell and regular grids, with \(\ell_2\) approximately half of that on the SLEVE grid.
Tracer minima and maxima for the centred linear and fourth order schemes are lower than those presented by \citet{schaer2002} because no interpolation is used to calculate the streamfunction.

The results of the horizontal advection test show that numerical errors are due either to misalignment of the flow with the grid, or to grid distortions.  Using the upwind-biased cubic scheme, distortions in the grid do not significantly distort the tracer.


\subsection{Terrain following advection}
In the horizontal advection test, results were least accurate on the BTF grid, where the grid was most non-orthogonal and flow was misaligned with the grid layers.  Here, we formulate a new tracer advection test in which the velocity field is everywhere tangential to the basic terrain following coordinate surfaces.
On the BTF grid, the flow is then aligned with the grid, but the data in the multidimensional advection stencil is not uniformly distributed because the BTF grid is non-orthogonal.
Conversely, on the cut cell grid, the flow is misaligned with the grid but, except in the lowest layer, the grid is orthogonal.
This test determines whether the primary source of numerical error is due to non-orthogonality or misalignment of the flow with grid layers.

The spatial domain, mountain profile, initial tracer profile and discretisation are the same as those in the horizontal tracer advection test, except for the timestep \(\Delta t = \SI{20}{\second}\).  The velocity field is defined using a streamfunction, $\Psi$, so that the discrete velocity field is non-divergent and follows the BTF coordinate surfaces given by equation~(\ref{eqn:btf}) such that
\begin{equation}
	\Psi(x,z) = -u_0 H \frac{z - h}{H - h} \label{eqn:streamfunc-btf}
\end{equation}
where $u_0 = \SI{10}{\meter\per\second}$, which is the horizontal wind speed where $h(x) = 0$.
The horizontal and vertical components of velocity, $u$ and $w$, are then given by
\begin{align}
	u &= -\frac{\partial \Psi}{\partial z} = u_0 \frac{H}{H - h}, \quad w = \frac{\partial \Psi}{\partial x} = u_0 H \frac{\mathrm{d} h}{\mathrm{d} x} \frac{H - z}{\left( H - h \right)^2} \label{eqn:uw-btf} \\
	\frac{\mathrm{d} h}{\mathrm{d} x} &= - h_0 \left[ 
		\beta \cos^2 \left( \alpha x \right) \sin \left( 2 \beta x \right) +
		\alpha \cos^2 \left( \beta x \right) \sin \left( 2 \alpha x \right)
	\right]
\end{align}
Unlike the horizontal advection test, flow extends from the top of the domain all the way to the ground.  The discrete velocity field is calculated using the streamfunction in the same way as the horizontal advection test.

At $t = \SI{10000}{\second}$ the tracer has passed over the mountain.  The horizontal position of the tracer centre can be calculated by integrating along the trajectory to find $t$, the time taken to pass from one side of the mountain to the other:
\begin{align}
	\mathrm{d}t &= \mathrm{d}x / u(x) \\
	t &= \int_0^x \frac{H - h(x)}{u_0 H}\:\mathrm{d}x \\
	t &= \frac{x}{u_0} - \frac{h_0}{16 u_0 H} \left[ 4x + \frac{\sin 2 (\alpha + \beta) x}{\alpha + \beta} \right.+ \nonumber \\
   &\ \left. \frac{\sin 2(\alpha - \beta) x}{\alpha - \beta} + 2 \left( \frac{\sin 2\alpha x}{\alpha} + \frac{\sin 2\beta x}{\beta} \right) \right]
\end{align}
Hence, we find that \(x(t=\SI{10000}{\second}) = \SI{51577.4}{\meter}\).  Because the velocity field is non-divergent, the flow accelerates over mountain ridges and the tracer travels \SI{1577.4}{\meter} further compared to advection in the purely horizontal velocity field.  Tracer height is unchanged downwind of the mountains because advection is parallel to the coordinate surfaces.

Tracer contours at \(t = \SI{0}{\second}, \SI{5000}{\second}\) and \(\SI{10000}{\second}\) are shown in Figure~\ref{fig:advection-tracer}.
\TODO{discuss figure~\ref{fig:advection-tracer}}
Tracer errors at \(t = \SI{10000}{\second}\) are shown for the \TODO{schemes} in figures \ref{fig:advection-tracer}x and \ref{fig:advection-tracer}x respectively.

$\ell_2$ errors and tracer extrema for this test are compared with the horizontal advection results in table~\ref{tab:advection}.  In the terrain following velocity field, tracer accuracy is greatest on the BTF grid.  Errors are about ten times larger on the SLEVE and cut cell grids compared to the BTF grid.


We conclude from this test that accuracy depends upon alignment of the flow with the grid, and accuracy is not significantly reduced by grid distortions.  Error on the BTF grid in the terrain following advection test is comparable with the error on the SLEVE grid in the horizontal advection test.

\subsection{Stratified atmosphere initially at rest}
\label{sec:resting}

An idealised terrain profile is defined along with a stably stratified atmosphere at rest in hydrostatic balance.  The analytic solution is time-invariant, but numerical errors in calculating the horizontal pressure gradient can give rise to spurious velocities which become more severe over steeper terrain \citep{klemp2011}.

The test setup follows the specification by \cite{klemp2011}.  The domain is \SI{200}{\kilo\meter} wide and \SI{20}{\kilo\meter} high, and the grid resolution is \(\Delta x = \Delta z^\star = \SI{500}{\meter}\).  All boundary conditions are no normal flow.

The wave-shaped mountain profile has a surface height, $h$, given by
\begin{align}
	h(x) = h_0 \exp \left( - \left( \frac{x}{a} \right)^2 \right) \cos^2 \left( \alpha x \right) \label{eqn:resting:mountain}
\end{align}
where $a = \SI{5}{\kilo\meter}$ is the mountain half-width, $h_0 = \SI{1}{\kilo\meter}$ is the maximum mountain height and $\lambda = \SI{4}{\kilo\meter}$ is the wavelength.  For the optimised SLEVE grid, the large-scale component $h_1$ is specified as
\begin{align}
h_1(x) = \frac{1}{2} h_0 \exp \left( - \left( \frac{x}{a} \right)^2 \right)
\end{align}
and, following \cite{leuenberger2010}, $s_1 = \SI{4}{\kilo\meter}$ is the large scale height, $s_2 = \SI{1}{\kilo\meter}$ is the small scale height, and the optimal exponent value of $n = 1.35$ is used.

The initial potential temperature field has $\theta(z = 0) = \SI{288}{\kelvin}$ and a constant static stability with Brunt-V\"ais\"al\"a frequency $N = \SI{0.01}{\per\second}$ everywhere, except for a more stable layer of $N = \SI{0.02}{\per\second}$ between $\SI{2}{\kilo\meter} \leq z \leq \SI{3}{\kilo\meter}$.  The Exner function of pressure is calculated so that it is in discrete hydrostatic balance in the vertical direction \citep{weller-shahrokhi2014}.  The damping function, \(\mu\), is set to \SI{0}{\per\second}.  Unlike \citet{klemp2011}, there is no eddy diffusion in the equation set.

The test was integrated forward by 5 hours using a timestep $\Delta t = \SI{100}{\second}$ on the BTF, SLEVE and cut cell grids, and a regular grid with flat terrain.  Maximum vertical velocities are presented in figure~\ref{fig:resting}.  In agreement with \citet{klemp2011}, vertical velocities are larger on more distorted grids.  However, magnitudes are smaller comparing results on the terrain following grids with those from \citet{klemp2011}.  
The results presented in figure~\ref{fig:resting}, which use a curl-free pressure gradient, have maximum spurious values of $w$ of \SI{0.33}{\meter\per\second} on the BTF grid, compared with a maximum of \(\sim \SI{7}{\meter\per\second}\) found by \citet{klemp2011} using their improved horizontal pressure gradient formulation.
The results in figure~\ref{fig:resting} have the same maximum errors as \citet{weller-shahrokhi2014} but, due to the more stable split into implicitly and explicitly treated terms (described in the appendix), the errors decay over time due to the dissipative nature of the advection scheme.

Unlike the result from \citet{klemp2011}, the SLEVE grid does not significantly reduce vertical velocities compared to the BTF grid.  However, errors are two orders of magnitude smaller on the cut cell grid with vertical velocities of \(\sim \SI{1e-4}{\meter\per\second}\).  The smallest error of \(\sim \SI{1e-10}{\meter\per\second}\) is found on the regular grid.

\citet{good2014} found the maximum vertical velocity in their cut cell model was \SI{1e-12}{\meter\per\second}, which is better than any result obtained here.  It is worth noting that our model stores values at the geometric centre of cut cells, whereas the model used by \citet{good2014} has cell centres at the centre of the uncut cell, resulting in the centre of some cut cells being below the ground (S.-J. Lock 2014, personal communication).  This means that the grid is effectively regular when calculating horizontal and vertical gradients.  This would account for the very small velocities found by \citet{good2014}.

In summary, spurious velocities in the resting atmosphere test were similar on both terrain following grids, with lower errors compared to those from \citet{klemp2011}.  The maximum vertical velocity was significantly decreased on the cut cell grid, so we conclude that non-orthogonality, or lack of alignment of the grid with surfaces of constant gravitational potential are a significant cause of numerical error in this test.


\subsection{Gravity waves}
\label{sec:gw}
The test originally specified by \citet{schaer2002} prescribes flow over terrain with small-scale and large-scale undulations which induces propagating and evanescent gravity waves.

Following \citet{melvin2010}, the domain is \SI{300}{\kilo\meter} wide and \SI{30}{\kilo\meter} high.
The mountain profile has the same form as equation~(\ref{eqn:resting:mountain}), but the gravity waves tests have a mountain height of $h_0 = \SI{250}{\meter}$.  As in the resting atmosphere test, $a = \SI{5}{\kilo\meter}$ is the mountain half-width and $\lambda = \SI{4}{\kilo\meter}$ is the wavelength.

A uniform horizontal wind $(u, w) = (10, 0)\:\si{\meter\per\second}$ is prescribed in the interior domain and at the inlet boundary.  No normal flow is imposed at the top and bottom boundaries and the velocity field has a zero gradient outlet boundary condition.

The initial thermodynamic conditions have constant static stability with $N = \SI{0.01}{\per\second}$ everywhere, such that
\begin{align}
	\theta(z) = \theta_0 \exp \left( \frac{N^2}{g} z \right) \label{eqn:thermal-profile}
\end{align}
where the temperature at $z=0$ is $\theta_0 = \SI{288}{\kelvin}$.
Potential temperature values are prescribed at the inlet and upper boundary using equation~(\ref{eqn:thermal-profile}), and a zero gradient boundary condition is applied at the outlet.  At the ground, fixed gradients are imposed by calculating the component of $\nabla \theta$ normal to each face using the vertical derivative of equation~(\ref{eqn:thermal-profile}).
For the Exner function of pressure, hydrostatic balance is prescribed on top and bottom boundaries and the inlet and outlet are zero normal gradient.

Sponge layers are added to the upper \SI{10}{\kilo\meter} and leftmost \SI{10}{\kilo\meter} at the inlet boundary to damp the reflection of waves.
The damping function, \(\mu\), is adapted from \citet{melvin2010} such that
\begin{align}
	\mu(x, z) &= \mu_\mathrm{upper} + \mu_\mathrm{inlet} \\
	\mu_\mathrm{upper}(z) &= \begin{cases}
		\overline{\mu} \sin^2 \left( \frac{\pi}{2} \frac{z - z_B}{H - z_B} \right) & \text{if } z \geq z_B \\
		0 & \text{otherwise} \\
	\end{cases} \\
	\mu_\mathrm{inlet}(x) &= \begin{cases}
		\overline{\mu} \sin^2 \left( \frac{\pi}{2} \frac{x_I - x}{x_I - x_0} \right) & \text{if } x < x_I \\
		0 & \text{otherwise}
	\end{cases}
\end{align}
where $\overline{\mu} = \SI{1.2}{\per\second}$ is the damping coefficient, $z_B = \SI{20}{\kilo\meter}$ is the bottom of the sponge layer, $H = \SI{30}{\kilo\meter}$ is the top of the domain, $x_0 = \SI{-150}{\kilo\meter}$ is the leftmost limit of the domain and $x_I = \SI{-140}{\kilo\meter}$ is the rightmost extent of the inlet sponge layer.  The sponge layer is only active on faces whose normal is vertical so that it damps vertical momentum only.

Note that, while the domain itself is \SI{30}{\kilo\meter} in height, for the purposes of generating BTF grids, the domain height is set to \SI{20}{\kilo\meter} because the sponge layer occupies the uppermost \SI{10}{\kilo\meter}.

The simulation is integrated forward by 5 hours and the timestep, $\Delta t = 8 \Delta z / \SI{300}{\second}$, is chosen so that it scales linearly with spatial resolution and, following the original test specified by \citet{schaer2002}, $\Delta t = \SI{8}{\second}$ when $\Delta z = \SI{300}{\meter}$.
Test results are compared between the BTF and cut cell grids at several resolutions.
The spatial and temporal resolutions tested are shown in table~\ref{tab:gw-resolutions}.  The lowest resolution is the same as that used by \citet{schaer2002}, and higher resolutions preserve the same aspect ratio.
The vertical resolution is chosen to test various configurations of cut cell grid.  At $\Delta z = \SI{300}{\meter}$, the mountain lies entirely within the lowest layer of cells, while at $\Delta z = \SI{250}{\meter}$ and $\Delta z = \SI{125}{\meter}$ the mountain peak is aligned with the interface between layers.  With increasing resolutions up to $\Delta z = \SI{50}{\meter}$, the orography intersects more layers and becomes better resolved.  Three of the cut cell grids are shown in figure~\ref{fig:gw-meshes} at $\Delta z = \SI{300}{\meter}$, $\SI{250}{\meter}$ and $\SI{200}{\meter}$.  Small cells are visible on the $\SI{200}{\meter}$ grid but, on the $\SI{250}{\meter}$ grid, the grid generator has merged the small cells with those in the layer above.

The ratio of minimum and maximum cell areas in the various grids is shown in table~\ref{tab:gw-meshes}, providing an indication of size of the smallest cut cells.  As expected, there is almost no variation in cell sizes on the BTF grids.  Small cells are generated on cut cell grids at resolutions finer than $\Delta z = \SI{300}{\meter}$ in which the terrain intersects grid layers.

At $\Delta z = \SI{300}{\meter}$, vertical velocities on the BTF and cut cell grids are visually indistinguishable (not shown).  They agree with the high resolution mass-conserving semi-implicit semi-Lagrangian solution from \citet{melvin2010}.
The initial thermal profile is subtracted from the potential temperature field at the end of the integration to reveal the structure of thermal anomalies.  The anomalies on the BTF grid with $\Delta z = \SI{50}{\meter}$ is shown in figure~\ref{fig:gw-theta}.  A vertical profile is taken at $x = \SI{50}{\kilo\meter}$, marked by the dashed line in figure~\ref{fig:gw-theta}, with results shown for the BTF grids in figure~\ref{fig:gw-sampleLine}a and on the cut cell grids in figure~\ref{fig:gw-sampleLine}b.
The position is chosen to be far away from the mountain where the gravity wave amplitude is small in order to better reveal numerical errors.
On all grids, potential temperature differences increase with height in the lowest \SI{1200}{\meter} at $x = \SI{50}{\kilo\meter}$, in agreement with the results seen in figure~\ref{fig:gw-theta}.  Results are seen to converge on all grids, with the exception of small errors in the lowest layers on the cut cell grids.

To summarize, results of the gravity waves test on all grids are in good agreement with the reference solution from \citet{melvin2010}.  The potential temperature field converges, though errors are found in the lowest layers on the cut cell grids.  The source of the errors in the cut cell grids will be investigated further with an advection test in the following subsection.

\subsection{Terrain following advection of thermal profile}
The potential temperature anomalies in the gravity waves test varied between terrain following and cut cell grids of the same resolution.  This variation may be due to differences in the wind fields between grids, or errors in the advection of potential temperature, amongst other possible causes.  To help establish the primary source of error, a new advection test is formulated in which the initial potential temperature field from the gravity waves test is used.  To eliminate any differences in wind fields, the field is advected in a fixed, terrain-following velocity field that mimics the flow in the gravity waves test.

The spatial domain, mountain profile, grid resolutions and timesteps are the same as those in the gravity waves test in section~\ref{sec:results}\ref{sec:gw}.  The terrain following velocity field is defined by the streamfunction:
\begin{align}
	\Psi(x,z) = -u_0 \left\{ \begin{array}{l l}
			H_\mathrm{TF} \frac{z - h}{H_\mathrm{TF} - h} & \enskip \text{if $z \leq H_\mathrm{TF}$} \\
			z & \enskip \text{if $z > H_\mathrm{TF}$}
	\end{array} \right.
\end{align}
where \(H_\mathrm{TF} = \SI{20}{\kilo\meter}\) is the level at which the terrain following layers become flat; the domain height is \(\SI{30}{\kilo\meter}\).
For $z \leq H_\mathrm{TF}$, the $u$ and $w$ components of velocity are given by equation~(\ref{eqn:uw-btf}), but $h(x)$ has the same form as equation~(\ref{eqn:resting:mountain}), hence the derivative is:
\begin{align}
	\frac{\mathrm{d} h}{\mathrm{d} x} = -h_0 \exp \left(- \left( \frac{x}{a} \right)^2 \right) \left[ \alpha \sin \left( 2 \alpha x \right) - \frac{2x}{a^2} \cos^2\left( \alpha x \right) \right]
\end{align}
For $z > H_\mathrm{TF}$, $u = u_0$ and $w = 0$.

The potential temperature field, \(\theta\), and its boundary conditions, are the same as those of the initial potential temperature field in the gravity waves test.
Following the gravity waves test, the simulation is integrated forward by \SI{18000}{\second}, by which time the potential temperature initially upwind of the mountain will have cleared the mountain range.
Hence, the analytic solution, $\theta_T$, can be found by considering the vertical displacement of the thermal profile by the terrain following velocity field:
\begin{align}
	\theta_T(x, z) = \theta_0 \exp \left( \frac{N^2}{g} z^\star(x, z) \right) 
\end{align}
where the potential temperature at $z = 0$, $\theta_0 = \SI{288}{\kelvin}$, and the transform, $z^\star$, is given by rearranging equation~(\ref{eqn:btf}).

Enlargements of the error field near the mountain are shown in figure~\ref{fig:thermalAdvection} at $\Delta z = \SI{50}{\meter}$ with contours of potential temperature overlayed.  Errors are too small to be visible on the BTF grid with a maximum $\ell_2$ error of \num{4.26e-4}.
However, on the cut cell grid, the maximum error is \TODO{\num{999}}.  Advection errors are apparent around mountainous terrain, with small cells having the largest errors.  These errors are advected horizontally along the lee slope, forming stripes.
The same error structure is present on all cut cell grids in which the terrain intersects the grid layers.

For comparison with the potential temperature anomalies in the gravity waves test, vertical profiles of potential temperature error are taken at $x = \SI{50}{\kilo\meter}$.  As seen in figure~\ref{fig:gw-theta}c, errors are negligible on the BTF grids, but figure~\ref{fig:gw-theta}d reveals significant errors in the lowest layers of the cut cell grids that were advected from the mountain peaks.  The magnitude of error is about ten times larger than the potential temperature anomalies found on the cut cell grids in the gravity waves test seen in figure~\ref{fig:gw-theta}b.  We offer two explanations for this difference: first, there are no restoring forces in the linear advection model and, second, the wind fields in the two tests are different.

While the magnitude and structure of error on the cut cell grids in this test differs from potential temperature anomalies in the gravity waves test, results on the BTF grids are in close agreement in both tests but not on the cut cell grids.  Therefore, it is likely that anomalies on the cut cell grids in the gravity waves test are primarily due to errors in the advection of potential temperature through cut cells.

\section{Conclusions}
We have presented a like-for-like comparison between terrain following and cut cell grids using a single model.  Accuracy on the BTF, SLEVE and cut cell grids was evaluated in a series of two-dimensional tests.

Across all tests, a high degree of accuracy was achieved for all grids.  Even on the highly-distorted BTF grid, which has previously been found to give poor results \citep{schaer2002,klemp2011,good2014}, errors were often small in the tests presented here.  In the first two tests, tracers were advected by horizontal and terrain following velocity fields.  We found that the accuracy of the upwind-biased cubic advection scheme depended upon alignment of the flow with the grid rather than on grid distortions.

Spurious vertical velocities were small in the resting initial state test, reaching a maximum of $\sim \SI{0.35}{\meter\per\second}$ on the BTF grid, compared to a maximum of $\sim \SI{7}{\meter\per\second}$ found by \citet{klemp2011}.  In the gravity waves test, vertical velocities were in good agreement with the reference solution from \citet{melvin2010} across all grids.

Cut cell grids reduced errors in two of the five tests.  First, in the horizontal advection test, accuracy was greatest on the cut cell grid.  Second, in the resting atmosphere test, spurious vertical velocities were two orders of magnitude smaller on the cut cell grid compared with the terrain following grids.

Conversely, in the first terrain following tracer advection test, errors were large on the SLEVE and cut cell grids where velocities were misaligned with the grids.  Errors were also large on the cut cell grids in the second terrain following thermal advection test.  This result suggests that, in the gravity waves test, potential temperature errors in the cut cell grids are primarily due to advection errors.

The tests we have presented demonstrate the trade-off between errors in calculating pressure gradient and advection terms: pressure gradient errors can be reduced by using a cut cell grid but, when flow follows the terrain, advection errors are reduced using a terrain following grid.

The cubic upwind-biased advection scheme takes an approach for treating small cut cells that differs from other existing approaches by adjusting weightings to ensure that advection remains upwind-biased near small cells.  The implementation of this technique in OpenFOAM is available at \url{https://github.com/hertzsprung/AtmosFOAM/tree/shaw-weller-2015-mwr} and will be described in greater detail a future publication.  Combined with semi-implicit timestepping and a grid generator that preserves cell length in the direction of the flow, small cells did not impose additional timestep constraints.

\acknowledgments
I am grateful to my co-supervisors John Methven and Terry Davies for their valuable input, and to Christoph Sch\"{a}r (ETH) for his assistance in reproducing his advection test results.  The authors thank the two anonymous reviewers whose comments greatly improved this manuscript.  I am thankful for the NERC studentship which helped fund this work.  Weller is funded by NERC grant NE/H015698/1.

%% APPENDICES
\begin{appendices}
\input{WellerAppendix}
\end{appendices}


% REFERENCES

\bibliographystyle{ametsoc2014}
\bibliography{references}

% TABLES

\begin{table*}
	\caption{Minimum and maximum tracer densities (\si{\kilogram\per\meter\cubed}) and \(\ell_2\) error norms, defined by equation~(\ref{eqn:l2-error}), at \(t = \SI{10000}{\second}\) in the horizontal and terrain following tracer advection tests using centred linear and cubic upwind-biased schemes.  For the horizontal advection test, \(\ell_2\) error norms, minimum and maximum values are given for the fourth order scheme using the modified code from \citet{schaer2002}.}
\label{tab:advection}
%
\centering
\footnotesize
\begin{tabular}{l l l l S S S S}
\hline\hline
                  &                     &                  & Analytic & {BTF}   & {SLEVE}         & {Cut cell}     & {No terrain} \\
\hline
Horizontal        & Centred linear      & \(\ell_2\) error & 0        & 0.284   & 0.0316          & 0.0304         & 0.0304      \\
                  &                     & min              & 0        & -0.275  & -0.0252         & -0.0251        & -0.0251     \\
                  &                     & max              & 1        & 0.925   & 0.985           & 0.985          & 0.985       \\
                  & Fourth order        & \(\ell_2\) error & 0        & 0.0938  & 0.00244         & {---}          & 0.00234     \\
                  &                     & min              & 0        & -0.0926 & -0.00174        & {---}          & -0.00178    \\
                  &                     & max              & 1        & 1.00    & 0.984           & {---}          & 0.983       \\
                  & Cubic upwind-biased & \(\ell_2\) error & 0        & 0.112   & 0.0146          & 0.00784        & 0.00784     \\
                  &                     & min              & 0        & -0.0464 & -0.0106         & -0.00674       & -0.00674    \\
                  &                     & max              & 1        & 0.922   & 0.982           & 0.983          & 0.983       \\
\hline
Terrain following & Centred linear      & \(\ell_2\) error & 0        & 0.0341  & 0.235           & 0.363          & {---}        \\
	          &                     & min              & 0        & -0.0245 & -0.120          & -1.24          & {---}        \\
		  &                     & max              & 1        & 0.985   & 0.950           & 1.01           & {---}        \\
		  & Cubic upwind-biased & \(\ell_2\) error & 0        & 0.0209  & 0.162           & 0.181          & {---}        \\
                  &                     & min              & 0        & -0.0110 & -0.0263         & -0.0284        & {---}        \\
                  &                     & max              & 1        & 0.983   & 0.865           & 0.851          & {---}        \\
\hline
\end{tabular}
\end{table*}

\begin{table}
	\caption{Spatial and temporal resolutions used in the gravity waves test.  The resolution of $\Delta z = \SI{300}{\meter}$ has the same parameters as the original test case specified by \citet{schaer2002}.  At other resolutions, the vertical resolution is prescribed, and horizontal and temporal resolutions are calculated to preserve the same aspect ratio as the original test case.}
	\label{tab:gw-resolutions}
%
\centering
\footnotesize
\begin{tabular}{S S S}
\hline\hline
{$\Delta z$ (\si{\meter})} & {$\Delta x$ (\si{\meter})} & {$\Delta t$ (\si{\second})} \\
\hline
500	& 833.3 & 13.33 \\
300	& 500	& 8 \\
250	& 416.7 & 6.667 \\
200	& 333.3 & 5.333 \\
150	& 250	& 4 \\
125	& 208.3 & 3.333 \\
100	& 166.7 & 2.667 \\
75	& 125	& 2 \\
50	& 83.33 & 1.333 \\
\hline
\end{tabular}
\end{table}

\begin{table}
	\caption{Cell area ratios of BTF and cut cell grids used in the gravity waves and thermal advection tests.  Cell sizes are almost uniform on BTF grids, but for the cut cell grids the cell area ratio gives an indication of the smallest cell sizes.}
	\label{tab:gw-meshes}
%
\centering
\footnotesize
\begin{tabular}{S S S}
\hline\hline

{$\Delta z$ (\si{\meter})} & \multicolumn{2}{c}{max/min cell area ratio} \\
 & {BTF} & {Cut cell} \\
\hline
500	& 1.01 &  1.68 \\
300	& 1.01 &  7.33 \\
250	& 1.01 &  5.44 \\
200	& 1.01 &  5.20 \\
150	& 1.01 &  10.0 \\
125	& 1.01 &  10.2 \\
100	& 1.01 &  10.0 \\
75	& 1.01 &  10.3 \\
50	& 1.01 &  10.4 \\
\hline
\end{tabular}
\end{table}


% FIGURES
\begin{figure*}
	\centering
	\includegraphics{../fig-meshes/fig-meshes.pdf}
	%
	\caption{Examples of (a) BTF, (b) SLEVE, and (c) a cut cell grid, showing cell edges in the lowest four layers.  The full two dimensional grids are \SI{20}{\kilo\meter} wide and \SI{20}{\kilo\meter} high.  SLEVE parameters are specified in the resting atmosphere test in section~\ref{sec:results}\ref{sec:resting}.  The cut cell grid was created by intersecting the terrain surface with a regular grid as described in section~\ref{sec:grid}.  Axes are in units of \si{\meter}.}
	\label{fig:grid}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics{../fig-grid-generation/fig-grid-generation.pdf}
	%
	\caption{Illustration of a slanted cell grid (a) before, and (b) after construction.
	The terrain surface, denoted by a heavy dotted line, intersects a uniform rectangular grid comprising six cells, $c_1, \ldots, c_6$.  The cell vertices, marked by open circles, are moved to the points at which the terrain intersects vertical cell edges, marked by filled circles.  Cells that have no volume are removed.  Where a cell has two vertices occupying the same point, the zero-length edge that joins those vertices is removed.  In this illustration, cells $c_5$ and $c_6$ are removed because they have no volume, and the zero-length edge at point $q$ is removed to create a triangular cell, $c_4$.  Point $p$ is moved down because it is within $\Delta z/5$ of the surface, avoiding the creation of a thin cell.}
	\label{fig:grid-generation}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics{../fig-advection-tracer/fig-advection-tracer.pdf}
%
	\caption{Horizontally advected tracer contours at \(t = \SI{0}{\second}\), \SI{5000}{\second} and \SI{10000}{\second} using (a) centred linear scheme on the BTF grid, (b) the upwind-biased cubic scheme on the cut cell grid, (c) the fourth order scheme from \citet{schaer2002} on the BTF grid, and (d) the upwind-biased cubic scheme on the BTF grid with contour intervals every 0.1.  Errors on the BTF grid at \(t = \SI{10000}{\second}\) are shown for (e) the fourth order scheme from \citet{schaer2002}, and (f) the upwind-biased cubic scheme, with contour intervals every 0.01.  Negative contours denoted by dotted lines.  The terrain profile is also shown immediately above the $x$ axis.  Subfigures (c) and (e) produced using the modified version of the code from \citet{schaer2002}.}
	\label{fig:advection-tracer}
\end{figure*}

\begin{figure}
	\centering
	\includegraphics{../fig-resting/fig-resting.pdf}
%
	\caption{Maximum spurious vertical velocity, \(w\) (\si{\meter\per\second}), in the resting atmosphere test with results on BTF, SLEVE, cut cell and regular grids using the model from \citet{weller-shahrokhi2014} which includes a curl-free pressure gradient formulation.}
	\label{fig:resting}
\end{figure}

\begin{figure*}
	\centering
	\includegraphics{../fig-gravityWaves-meshes/fig-gravityWaves-meshes.pdf}
	%
	\caption{Cut cell grids used for the gravity waves and thermal advection tests at (a) $\Delta z = \SI{300}{\meter}$, (b) $\Delta z = \SI{250}{\meter}$, and (c) $\Delta z = \SI{200}{\meter}$.  The mountain peak $h_0 = \SI{250}{\meter}$.  At $\Delta z = \SI{250}{\meter}$, the grid creation process has merged small cells with the cells in the layer above but, at $\Delta z = \SI{200}{\meter}$, small cells have been retained.  The full two dimensional grids are \SI{300}{\kilo\meter} wide and \SI{30}{\kilo\meter} high.  Axes are in units of \si{\meter}.}
	\label{fig:gw-meshes}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics[width=6in]{../fig-gravityWaves-theta/fig-gravityWaves-theta.pdf}
%
	\caption{Differences in potential temperature between the start and end of the gravity waves test on the BTF grid with $\Delta z = \SI{50}{\meter}$.  The dashed line at $x = \SI{50}{\kilo\meter}$ marks the position of the vertical profile in figure~\ref{fig:gw-sampleLine}.  Axes are in units of \si{\meter}.}
	\label{fig:gw-theta}
\end{figure*}

\begin{figure*}
	\centering
	\includegraphics{../fig-gravityWaves-sampleLine/fig-gravityWaves-sampleLine.pdf}
%
	\caption{Vertical profiles of potential temperature differences between the start and end of the gravity waves test on (a) the BTF grid, and (b) the cut cell grid.  Results are compared with thermal advection tests results, showing differences in tracer density between the numeric and analytic solutions at $t = \SI{18000}{\second}$ on (c) the BTF grid, and (d) the cut cell grid.  The results are convergent, except for errors found in the lowest layers on the cut cell grids.}
	\label{fig:gw-sampleLine}
\end{figure*}

\begin{figure}
	\centering
	\includegraphics{../fig-thermalAdvection/fig-thermalAdvection.pdf}
%
	\caption{Error in tracer density in the thermal advection test at a resolution of $\Delta z = \SI{50}{\meter}$ on (a) the BTF grid, and (b) the cut cell grid.  Errors are negligible on the BTF grid, but on the cut cell grid errors are generated near mountainous terrain and are advected horizontally on the lee side.  Contours in tracer density are overlayed.  Axes are in units of \si{\meter}.}
	\label{fig:thermalAdvection}
\end{figure}

\end{document}
