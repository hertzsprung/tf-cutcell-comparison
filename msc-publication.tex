\documentclass[twocol]{ametsoc}
\journal{mwr}

\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{siunitx}

\bibpunct{(}{)}{;}{a}{}{,}

\title{Comparison of Terrain Following and Cut Cell Grids with a Non-Hydrostatic Model}
\authors{James Shaw\correspondingauthor{Dept., Institution, Address, City, State/Country.}}
\affiliation{}
\email{j.shaw@pgr.reading.ac.uk}

\abstract{Enter the text of your abstract here.}

\begin{document}
\newcommand{\TODO}[1]{\textcolor{purple}{TODO: \emph{#1}}}

\maketitle

\TODO{Builds on the work of \citet{schaer2002}, \citet{klemp2011}, \citet{weller-shahrokhi2014} (all MWR) \\
Results also compared with \citet{melvin2010} (QRJ), maybe zaengl2012 (MWR), \citet{good2014} (Atmos Sci Letters)}

\section{Introduction}
Representing orography accurately in numerical weather prediction systems is necessary to model downslope winds and local precipitation patterns.  There are two main approaches to represent orography on a grid: terrain following layers and cut cells.  Both methods align cells in vertical columns.

With terrain following (TF) layers the terrain's influence decays with height so that the bottommost layers follow the underlying surface closely while the uppermost layers are flat.  TF layers are usually implemented on a rectangular computational grid using transformed coordinates.

It is well-known that TF coordinates perform badly in the presence of steep orography: as model resolution increases, steeper gradients lead to larger truncation errors in calculating the horizontal pressure gradient which result in spurious winds \citep{dempsey-davis1998,steppeler2002}.

Much work has been done to reduce error associated with TF coordinates: firstly by smoothing the effects of terrain with height \citep{schaer2002,leuenberger-2010,klemp2011} and, secondly, by improving the accuracy in calculating the horizontal pressure gradient itself \citep{klemp2011,zaengl2012}.

Despite their associated numerical errors, TF coordinates are attractive because their rectangular structure is simple to process by computer, boundary layer resolution can be increased with variable spacing of vertical layers \citep{schaer2002}, and cell sizes remain almost constant \citep{jebens2011}.

Cut cells is an alternative method in which cells that lie entirely below the terrain are removed, and those that intersect the surface are modified in shape so that they more closely fit the terrain.  This modification means that some cells become very small, which can reduce computational efficiency \citep{klein2009}, and several approaches have been tried to alleviate the problem \citep{steppeler2002,yamazaki-satomura2010,jebens2011}.

Several studies have found that cut cells produce more accurate results when compared to TF coordinates.  Spurious winds seen in TF coordinates are not present and errors do not increase with steeper terrain \citep{good2014}.  A comparison of TF and cut cells using real initial data by \citet{steppeler2006} found that precipitation patterns, temperature and wind fields were forecast more accurately in the cut cell model.  

Many comparisons of TF and cut cell grids have made between different models.  On the contrary, this study uses the nonhydrostatic model from \citet{weller-shahrokhi2014} to enable a like-for-like comparison between BTF, SLEVE and cut cell grids for idealised, two-dimensional test cases from the literature.  \TODO{final bit of intro: in section 2, section 3 etc etc}

\TODO{TF grids often shown to have lesser accuracy than cut cells in some test cases, often significantly so.  Our results demonstrate that accuracy need not be much reduced and can even be better than cut cells.}

\section{Grids}
\TODO{introduce this section}
\citet{galchen-somerville1975} proposed a basic terrain following (BTF) coordinate defined as 
\begin{equation}
	z = \left( H - h \right) \left( z^\star / H \right) + h
\end{equation}
where, in two dimensions, \(z(x, z^\star)\) is the height of the coordinate surface at level \(z^\star\), \(H\) is the height of the domain, and \(h(x)\) is the height of the terrain surface.  Using this coordinate, the terrain's influence decays linearly with height but disappears only at the top of the domain.

The sigma coordinate transform of \citet{phillips1957} is equivalent to the BTF coordinate transform since they both decay linearly.  However, since they decay with pressure rather than height, sigma coordinates also change with horizontal variations in pressure.

The smooth level vertical (SLEVE) coordinate proposed by \citet{schaer2002} achieves a more regular TF grid in the middle and top of the domain than the BTF coordinate.  The terrain height is split into large-scale and small-scale components, \(h_1\) and \(h_2\), such that \(h = h_1 + h_2\), with each component having a different exponential decay. The transformation is defined as 
\begin{align}
	z &= z^\star + h_1 b_1 + h_2 b_2
\intertext{where the vertical decay functions are given by}
	b_i &= \frac{\sinh \left( \left( H / s_i \right)^n - \left( z^\star / s_i \right)^n \right)}{\sinh \left( H / s_i \right)^n}
\end{align}
with \(s_1\) and \(s_2\) are the scale heights of large-scale and small-scale terrain respectively.  The exponent \(n\) was introduced by \citet{leuenberger2010} in order to increase cell thickness in the layers nearest the ground, allowing longer timesteps and permitting more accurate calculation of parameterised low-level heat and momentum fluxes.  \citet{leuenberger2010} found the exponent has an optimal value of \(n = 1.35\).  Choosing \(n = 1\) gives the decay functions used by \citet{schaer2002}.

\TODO{Explain how SnapCol grid is constructed?}

\section{Results}
A series of standard, two-dimensional tests were performed over idealised orography.  For each test, results on the BTF, SLEVE and cut cell grid are compared.
We use a finite volume discretisation of the fully-compressible Euler equations described by \citet{weller-shahrokhi2014}.  The model has a curl-free pressure gradient formulation, an upwind-biased cubic advection scheme, and uses a Lorenz staggering of thermodynamic variables.  No explicit diffusion is used in any of the tests.

\subsection{Advection}

Following \citet{schaer2002}, a tracer is transported above wave-shaped terrain by solving the advection equation for a prescribed horizontal wind.  This challenges the accuracy of the advection scheme in the presence of grid distortions.  The spatial domain, terrain profile, wind field, tracer, SLEVE scale heights are given by \citet{schaer2002}.  The optimisation of SLEVE by \citet{leuenberger2010} is not used, so the exponent $n = 1$.  A tracer is placed above and to the left of the mountain with a magnitude of 1 at its centre and 0 at the perimeter.

While the continuous wind field specified by \citet{schaer2002} is non-divergent, this is not true of the discrete wind field on non-orthogonal grids.  A potential, $p$, is used to correct the wind field, $\bm{u}$, so that is non-divergent such that
\begin{align}
	\nabla \cdot \left( \bm{u} + \nabla p \right) = 0,
\intertext{which can be rearranged to give a Poisson equation}
	\nabla^2 p = - \nabla \cdot \bm{u}.
\end{align}

The flux form of the advection equation, \(\partial \phi / \partial t + \nabla \cdot \left( \bm{u} \phi \right) = 0\), is solved using an upwind-biased cubic advection scheme which is non-monotonic and not flux corrected.  The time derivative is solved using a second order Runge-Kutta scheme.  \TODO{I ought to understand this method myself!}

Unlike \citet{schaer2002} who use periodic lateral boundaries, a fixed value of 0 is used at the inlet boundary and all other boundaries have zero gradient.
Tests are integrated forward in time for \SI{10000}{\second} with a timestep of \(\Delta t = \SI{25}{\second}\).

The test was executed on the BTF, SLEVE and cut cell grids, and on a regular grid with flat terrain.  Tracer contours at \(t = \SI{0}{\second}, \SI{5000}{\second}\) and \(\SI{10000}{\second}\) are shown in Figure~\ref{fig:advection-tracer}.  The result from \citet{schaer2002} using a fourth-order centred scheme and sigma coordinates (\ref{fig:advection-tracer}a) is compared with the upwind-biased cubic scheme on (\ref{fig:advection-tracer}b) the BTF grid, and (\ref{fig:advection-tracer}c) cut cell grid.

Tracer magnitude and shape are well-preserved on all grids, both above the mountain at \(t = \SI{5000}{\second}\) and past the mountain at \(t = \SI{10000}{\second}\).  Advection is most accurate on the cut cell grid (figure~\ref{fig:advection-tracer}c) and regular grid (not shown).  As found by \citet{good2014}, the result is the same on both grids.  This is to be expected since the wind is zero in the region of the ground and both grids are orthogonal elsewhere.  On the BTF grid, the tracer is less distorted by the cubic upwind-biased scheme (figure~\ref{fig:advection-tracer}b) compared to the fourth-order centred scheme from \citet{schaer2002} (figure~\ref{fig:advection-tracer}a).

Minimum and maximum tracer values and \(\ell^2\) error norms on the BTF, SLEVE, cut cell and regular grids are summarised in table~\ref{tab:advection}.  The results of the cubic upwind-biased scheme on TF and regular grids are comparable with those for the fourth-order centred scheme from \citet{schaer2002}.  Error is largest on the BTF grid with \(\ell^2 = \num{0.00758}\) but significant reduced on the SLEVE grid with \(\ell^2 = \num{0.00110}\).  The error is approximately halved by changing from the SLEVE grid to the cut cell grid.

The results of the tracer advection test show that, given an advection scheme of a sufficiently high order, distortions in the grid do not significantly distort the tracer.

\begin{figure}
	\centering
	\includegraphics{../msc-publication-fig-advection-tracer/fig-advection-tracer.pdf}
%
	\caption{Horizontally advected tracer contours at \(t = \SI{0}{\second}\), \SI{5000}{\second} and \SI{10000}{\second} using (a) the fourth-order centred difference scheme with sigma coordinates from \citet{schaer2002}, and the upwind-biased cubic scheme on (b) BTF grid, (c) cut cell grid.  Contour intervals are every 0.1.}
	\label{fig:advection-tracer}
\end{figure}

\begin{figure}
	\centering
	\includegraphics{../msc-publication-fig-advection-error/fig-advection-error.pdf}
	%
	\caption{Errors in horizontal tracer advection at \(t = \SI{10000}{\second}\) using (a) the fourth-order centred difference scheme with sigma coordinates from \citet{schaer2002}, (b) the upwind-biased cubic scheme on a BTF grid.  Contour intervals are every 0.01 with negative contours denoted by dashed lines.}
	\label{fig:advection-error}
\end{figure}

\begin{table}[t]
	\caption{Minimum and maximum tracer magnitudes and \(\ell^2\) error norms at \(t = \SI{10000}{\second}\) in the tracer advection test.  Results of the cubic upwind-biased scheme are compared with the fourth-order centred scheme from \citet{schaer2002}.}
\label{tab:advection}
%
\centering
\footnotesize
\begin{tabular}{ l l l l l l }
\hline\hline
& \multicolumn{3}{c}{Cubic upwind-biased} & \multicolumn{2}{c}{Sch\"ar 4th order} \\
& \(\ell^2\) error & min & max & min & max \\
\hline
Analytic  & 0 & 0 & 1 & 0 & 1 \\
BTF 	  & \num{0.00758} & \num{-0.034} & \num{0.928} & \num{-0.058} & \num{1.001} \\
SLEVE 	  & \num{0.00110} & \num{-0.011} & \num{0.981} & \num{-0.002} & \num{0.984} \\
Cut cell  & \num{0.00058} & \num{-0.007} & \num{0.982} & \multicolumn{1}{c}{---} & \multicolumn{1}{c}{---} \\
No orography & \num{0.00058} & \num{-0.007} & \num{0.982} & \num{-0.002} & \num{0.984} \\
\hline
\end{tabular}
\end{table}


\subsection{Resting atmosphere}
An idealised terrain profile is defined along with a stratified atmosphere in hydrostatic balance.  The analytic solution is time-invariant, but numerical errors in calculating the horizontal pressure gradient can give rise to spurious velocities which become more severe over steeper terrain \citet{klemp2011}.  The test setup follows the specification by \citet{klemp2011} but uses the smaller domain and rigid boundaries from \cite{weller-shahrokhi2014}.

The test was integrated forward by 5 hours on the BTF, SLEVE and cut cell grids, and a regular grid with flat terrain.  Maximum vertical velocities are compared with the results from \citet{klemp2011} in figure~\ref{fig:resting} (note different vertical scales).  In agreement with \citet{klemp2011}, vertical velocities are larger on more distorted grids.  However, magnitudes are smaller comparing results on the terrain following grids with those from \citet{klemp2011}, with $w$ reaching a maximum of \(\sim \SI{0.35}{\meter\per\second}\) on the BTF grid in our test compared with a maximum of \(\sim \SI{10}{\meter\per\second}\) found by \citet{klemp2011}.

Unlike the result from \citet{klemp2011}, the SLEVE grid does not significantly reduce vertical velocities compared to the BTF grid.  However, errors are three orders of magnitude smaller on the cut cell grid with vertical velocities of \(\sim \SI{1e-3}{\meter\per\second}\).  The smallest error of \(\sim \SI{1e-10}{\meter\per\second}\) is found on the regular grid.

\citet{good2014} found the maximum vertical velocity in their cut cell model was \SI{1e-12}{\meter\per\second}, which is better than any result obtained using the model by \citet{weller-shahrokhi2014}.  It is worth noting that \citet{good2014} used a timestep of \SI{1.01}{\second} instead of the \SI{100}{\second} timestep specified by \citet{klemp2011} that was used to obtain the results presented here.  In addition, in the model used by \citet{good2014}, cell centres are in the centre of the uncut cell, resulting in the centre of some cut cells being below the ground (S.-J. Lock 2014, personal communication).  This means that the grid is effectively regular when calculating horizontal and vertical gradients.  These two modelling decisions may account for the very small velocities found by \citet{good2014}.

In summary, spurious velocities in the resting atmosphere test were similar on both terrain following grids, with much lower errors compared to those from \citet{klemp2011}.  The maximum vertical velocity was significantly decreased on the cut cell grid, so we conclude that non-orthogonality is a significant cause of numerical error in this test.

\begin{figure*}
	\centering
	\includegraphics{../msc-publication-fig-resting/fig-resting.pdf}
%
	\caption{Maximum spurious vertical velocity, \(w\) (\si{\meter\per\second}), in the resting atmosphere test with results on (a) BTF, SLEVE, Hybrid Terrain Following (HTF) and Smoothed Terrain Following (STF) coordinates from \citet{klemp2011}, (b) BTF, SLEVE, cut cell and regular grids using the model from \citet{weller-shahrokhi2014}.  Note that vertical scales differ.}
	\label{fig:resting}
\end{figure*}

\subsection{Gravity waves}
\begin{itemize}
	\item \TODO{Motivation: it models a real dynamic process?}
	\item Specify domain, thermodynamics, prescribed inlet wind
	\item Specify sponge layers, BCs
	\item Compare BTF, SLEVE and SnapCol results (SLEVE only briefly as visually identical to BTF)
\end{itemize}

Analysis:
\begin{itemize}
	\item \(w\) contours visually similar on all grids, agree with \citet{melvin2010} (Figure~\ref{fig:gw-w})
	\item \TODO{divergence might help explain computational mode -- it's greater on the SnapCol grid (MSc dissertation Figure 4.15e)}
	\item \(\theta\) anomalies similar on all grids EXCEPT...
	\item ... on SnapCol grid in lee of mountain near the ground. (Figure~\ref{fig:gw-theta})
	\item \TODO{worth mentioning implications of this?  1. reduced stability, although not enough to create vertical motion in this instance 2. would disrupt clouds 2. model has no viscosity so thermal mixing should not occur in theory}
	\item Lorenz computation mode has been excited because Exner sample line at $x = \SI{50}{\kilo\meter}$ is in hydrostatic balance (Figure~\ref{fig:gw-exner-theta})
	\item \TODO{We can speculate on what excites the computational mode, but perhaps better not to?}
	\item No evidence of small cell problem -- \TODO{don't know that we can say much here without another vertical momentum test; our hypothesis about the quasi-horizontal flow isn't backed up with a test case}
	\item Conclusion: results similar on all grids, agree with literature, except for Lorenz computational mode on SnapCol grid
\end{itemize}

\begin{figure}
	\centering
	\includegraphics{../msc-publication-fig-gravityWaves/fig-gravityWaves.pdf}
%
	\caption{Vertical cross section of vertical velocity contours in the gravity waves test after 5 hours on (a) the BTF grid compared with (b) the mass-conserving semi-implicit semi-Lagrangian solution from \citet{melvin2010}.  Contours are every \SI{5e-2}{\meter\per\second} with solid lines denoting ascent and dashed lines descent.}
	\label{fig:gw-w}
\end{figure}

\begin{figure*}
	\centering
	\includegraphics{../msc-publication-fig-gravityWaves-theta/fig-gravityWaves-theta.pdf}
%
	\caption{Anomalies in potential temperature in the gravity waves test after 5 hours.  The central domain in the lowest \SI{12}{\kilo\meter} is shown on (a) the BTF grid, and (c) the cut cell grid.  The four lowest layers of each grid are shown for (b) BTF, and (d) cut cell grids, using a narrower potential temperature scale.}
	\label{fig:gw-theta}
\end{figure*}

\begin{figure}
	\centering
	\includegraphics{../msc-publication-fig-gravityWaves-sampleLine/fig-gravityWaves-sampleLine.pdf}
%
	\caption{Vertical profiles of the Exner function of pressure, \(\Pi\), and potential temperature, \(\theta\), in the gravity waves test.  Exner profile is visually identical on all grids for both mountain heights; for clarity, the Exner profile is only plotted for the BTF grid.  The computational mode is manifested as a zig-zag in potential temperature on the cut cell grid which.  Doubling the mountain height from \SI{250}{\meter} to \SI{500}{\meter} increases the severity of the computational mode but has negligible effect on the BTF grid.  Results on the SLEVE grid (not shown) are qualitatively the same as those on the BTF grid for both mountain heights.}
	\label{fig:gw-exner-theta}
\end{figure}


\section{Conclusions}
\begin{enumerate}
	\item BTF grid isn't as bad as people say it is.  We found that:
	\begin{itemize}
		\item Upwind-biased cubic advection scheme accurately advects a tracer in non-divergent flows (Figure~\ref{fig:advection-tracer}, \ref{fig:advection-error}, Table~\ref{tab:advection})
		\item spurious vertical velocities are small in resting atmosphere (Figure~\ref{fig:resting})
		\item gravity waves results visually as good as reference solution from \citet{melvin2010} (figure~\ref{fig:gw-w})
	\end{itemize}

	\item Cut cell grids can be worse than TF grids:
	\begin{itemize}
		\item Lorenz computational mode found on SnapCol grid only (figure~\ref{fig:gw-theta}, \ref{fig:gw-exner-theta})
	\end{itemize}

	\item Cut cell grids can also be better than TF grids in more artificial test cases:
	\begin{itemize}
		\item SnapCol $w$ two orders of magnitude smaller in resting atmosphere test
		\item SnapCol advection test as good as noOrography
	\end{itemize}
\end{enumerate}

\textbf{With the exception of the Lorenz computational mode on the SnapCol grid in the gravity waves test, results were satisfactory across BTF, SLEVE and SnapCol grids in all three test cases.}

Miscellany:
\begin{itemize}
	\item Advection accuracy depends on alignment of the flow with grid layers (\TODO{we kinda need wobblyTracerAdvection to reach this conclusion})
\end{itemize}

\section{Further work}
\begin{itemize}
	\item Lorenz computational mode motivates formulation of C-P staggering for cut cell grids
	\item Find out what excites the Lorenz computational mode
	\item \TODO{anything else?}
\end{itemize}

\acknowledgments
Start acknowledgments here.

% REFERENCES

\bibliographystyle{ametsoc2014}
\bibliography{references}

% TABLES


% FIGURES

\end{document}
